/*! ################################################################
 * Copyright (c) 2010 Amazon.com, Inc., and its Affiliates.
 * All rights reserved.
 * Not to be reused without permission
 * ################################################################
 */
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.cs=="undefined"){amzn.cs={};
}if(typeof amzn.cs.log=="undefined"){amzn.cs.log={};
}amzn.cs.log.LOG_EVENT_NAME="amzn.cs.log.LogEvent";
amzn.cs.log._loggersByName={};
amzn.cs.log._levels={DEBUG:1,LOG:2,INFO:3,WARN:4,ERROR:5,OFF:6};
amzn.cs.log._throw=function(msg){throw"[amzn.cs.log] "+msg;
};
amzn.cs.log._Logger=function(name){this._name=name;
this._level=amzn.cs.log._levels.DEBUG;
this._logCallbacks=[];
};
amzn.cs.log._Logger.prototype._log=function(funcName,level,args){if(level>=this._level){if(this.prefix){if(typeof this.prefix=="function"){Array.prototype.unshift.call(args,this.prefix());
}else{Array.prototype.unshift.call(args,this.prefix);
}}if(typeof console!=="undefined"){var func;
if(typeof console[funcName]!="undefined"){func=console[funcName];
}else{if(typeof console.log!="undefined"){func=console.log;
}}if(func){if(typeof func.apply=="function"){func.apply(console,args);
}else{func(Array.prototype.join.call(args," "));
}}}for(var i=0;
i<this._logCallbacks.length;
i++){this._logCallbacks[i](args);
}var logEventData={name:this._name,level:level,args:Array.prototype.splice.call(args,0),time:new Date().getTime()};
$(document).trigger(amzn.cs.log.LOG_EVENT_NAME,[logEventData]);
}};
amzn.cs.log._LogAccumulator=function(options){this._options=$.extend({},options,{maxLogs:100,includeJsErrors:true});
var self=this;
this._lastErrorTime=0;
this._logs=[];
this._listenForLogs();
if(this._options.includeJsErrors){this._listenForJsErrors();
}};
amzn.cs.log._LogAccumulator.prototype._pushLogEntry=function(entry){this._logs.push(entry);
if(this._logs.length>this._options.maxLogs){this._logs.shift();
}if(entry.level==amzn.cs.log._levels.ERROR){this._lastErrorTime=new Date().getTime();
}};
amzn.cs.log._LogAccumulator.prototype._listenForLogs=function(){var self=this;
$(document).bind(amzn.cs.log.LOG_EVENT_NAME,function(event,data){self._pushLogEntry(data);
});
};
amzn.cs.log._LogAccumulator.prototype._listenForJsErrors=function(){var self=this;
oldOnError=window.onerror;
window.onerror=function(message,url,lineNumber){self._pushLogEntry({js:true,level:amzn.cs.log._levels.ERROR,time:new Date().getTime(),msg:message,url:url,line:lineNumber});
if(oldOnError){return oldOnError(message,url,lineNumber);
}else{return false;
}};
};
amzn.cs.log.initLogAccumulator=function(options){if(!amzn.cs.log._accumulator){amzn.cs.log._accumulator=new amzn.cs.log._LogAccumulator(options);
return true;
}else{return false;
}};
amzn.cs.log.getLogAccumulator=function(){return amzn.cs.log._accumulator;
};
amzn.cs.log._LogAccumulator.prototype.hasError=function(){return this._lastErrorTime>=this._logs[0].time;
};
amzn.cs.log._LogAccumulator.prototype.dump=function(){return JSON.stringify(this._logs);
};
amzn.cs.log.getLogger=function(name){var logger=amzn.cs.log._loggersByName[name];
if(typeof logger=="undefined"){logger=new amzn.cs.log._Logger(name);
amzn.cs.log._loggersByName[name]=logger;
}return logger;
};
amzn.cs.log.destroyLogger=function(name){delete amzn.cs.log._loggersByName[name];
};
amzn.cs.log._Logger.prototype.turnOff=function(){this.setLevel("OFF");
};
amzn.cs.log._Logger.prototype.setLevel=function(levelName){var level=amzn.cs.log._levels[levelName.toUpperCase()];
if(typeof level=="undefined"){amzn.cs.log._throw("unknown level: "+levelName);
}this._level=level;
};
amzn.cs.log._Logger.prototype.setPrefix=function(prefix){this.prefix=prefix;
};
amzn.cs.log._Logger.prototype.addCallback=function(func){this._logCallbacks.push(func);
};
amzn.cs.log._Logger.prototype.debug=function(){this._log("debug",amzn.cs.log._levels.DEBUG,arguments);
};
amzn.cs.log._Logger.prototype.log=function(){this._log("log",amzn.cs.log._levels.LOG,arguments);
};
amzn.cs.log._Logger.prototype.info=function(){this._log("info",amzn.cs.log._levels.INFO,arguments);
};
amzn.cs.log._Logger.prototype.warn=function(){this._log("warn",amzn.cs.log._levels.WARN,arguments);
};
amzn.cs.log._Logger.prototype.error=function(){this._log("error",amzn.cs.log._levels.ERROR,arguments);
};
})(jQuery);
(function($){var ITEM_TYPE_SUFFIX="__type__";
if(typeof TelephonyUtil=="undefined"){TelephonyUtil={};
}TelephonyUtil.Array={indexOf:function(arr,findMe){if(typeof arr.indexOf!="undefined"){return arr.indexOf(findMe);
}else{var len=arr.length;
for(var i=0;
i<len;
i++){if(findMe===arr[i]){return i;
}}return -1;
}},contains:function(arr,findMe){return TelephonyUtil.Array.indexOf(arr,findMe)!=-1;
}};
TelephonyUtil.isIE6=typeof navigator!="undefined"&&/msie|MSIE 6/.test(navigator.userAgent);
TelephonyUtil.putInLocalStorage=function(key,item){var type=typeof item;
if(window.localStorage&&localStorage.setItem){try{if(type==="object"){item=JSON.stringify(item);
}localStorage.setItem(key,item);
localStorage.setItem(key+ITEM_TYPE_SUFFIX,type);
}catch(e){TelephonyUtil.logError("Could not save key "+key+"in localStorage",e);
}}};
TelephonyUtil.getFromLocalStorage=function(key){var item=null;
if(window.localStorage&&localStorage.getItem){var type=null;
try{type=localStorage.getItem(key+ITEM_TYPE_SUFFIX);
item=localStorage.getItem(key);
}catch(e){TelephonyUtil.logError("Could not get item with key "+key+"in localStorage",e);
}if(typeof item==="string"&&type==="object"){var itemJson=item;
try{item=JSON.parse(itemJson);
}catch(e){TelephonyUtil.logError("Could not parse json: "+itemJson,e);
}}}return item;
};
TelephonyUtil.logError=function(message,errorObj){if(window.console&&console.error){console.error(message,errorObj);
}};
TelephonyUtil.createMapCache=function(options){return new TimeExpiryMapCache(options);
};
var DEFAULT_CACHE_SWEEP_INTERVAL=60000;
var TimeExpiryMapCache=function(options){var self=this;
this._options=$.extend({sweepTime:DEFAULT_CACHE_SWEEP_INTERVAL,onSweepComplete:function(){}},options);
this._map={};
this._hasExpired=function(entry){return entry&&entry.expiration<new Date().getTime();
};
this._sweep=function(){var deleteThese=[];
var key;
for(key in self._map){var entry=self._map[key];
if(self._hasExpired(entry)){deleteThese.push(key);
}}for(var i=0;
i<deleteThese.length;
i++){key=deleteThese[i];
delete self._map[key];
}self._options.onSweepComplete();
};
window.setInterval(function(){self._sweep();
},self._options.sweepTime);
this.put=function(key,value,cacheTime){if(!cacheTime){return;
}var expiration=new Date().getTime()+cacheTime;
var entry={expiration:expiration,value:value};
self._map[key]=entry;
};
this.get=function(key){var entry=self._map[key];
if(entry){if(self._hasExpired(entry)){delete self._map[key];
}else{return entry.value;
}}};
};
TelephonyUtil.setTimeout=function TelephonyUtil_setTimeout(callback,timeoutMs,unacceptableEarliness){var context={timeoutCount:0,earlinesses:[]};
_setTimeoutInternal(callback,timeoutMs,unacceptableEarliness,context);
return context;
};
var SET_TIMEOUT_TOO_MANY_RECURSIONS=20;
function _setTimeoutInternal(callback,timeoutMs,unacceptableEarliness,context){context.timeoutCount++;
if(context.timeoutCount===SET_TIMEOUT_TOO_MANY_RECURSIONS){callback.apply(window,arguments);
return;
}unacceptableEarliness=unacceptableEarliness||500;
var expectedTime=new Date().getTime()+timeoutMs;
var callbackWrapper=function TelephonyUtil_setTimeout_callbackWrapper(){var earliness=expectedTime-new Date().getTime();
context.earlinesses.push(earliness);
if(earliness>=unacceptableEarliness){_setTimeoutInternal(callback,earliness,unacceptableEarliness,context);
}else{callback.apply(window,arguments);
}};
context.timerId=window.setTimeout(callbackWrapper,timeoutMs);
}var REGEXP_GUID=/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/;
TelephonyUtil.sanitizeGUID=function(guid){if(typeof guid=="string"){var match=guid.match(REGEXP_GUID);
if(match){return match[0];
}}return guid;
};
TelephonyUtil.trimXHR=function(xhr){if(!xhr){return{};
}return{status:xhr.status,statusText:xhr.statusText,responseText:xhr.responseText,timeout:xhr.timeout,readyState:xhr.readyState};
};
TelephonyUtil.hitch=function(context,func){if(!func){return func;
}var originalArgs=Array.prototype.slice.call(arguments,2);
return function(){var additionalArgs=Array.prototype.slice.call(arguments,0);
var combinedArgs=originalArgs.concat(additionalArgs);
func.apply(context,combinedArgs);
};
};
TelephonyUtil.validateParamIsNotMissing=function(valueName,value){if(typeof value==="undefined"||value===null){throw new Error('No value provided for parameter "'+valueName+'", but it is required.');
}};
TelephonyUtil.validateParamIsNotEmpty=function(valueName,value){TelephonyUtil.validateParamIsNotMissing(valueName,value);
if(!$.isFunction(value)&&typeof value.length==="number"&&value.length===0){throw new Error('An empty value was provided for parameter "'+valueName+'", but it is required to be non-empty.');
}};
TelephonyUtil.validateParamIsFunction=function(valueName,value){TelephonyUtil.validateParamIsNotMissing(valueName,value);
if(!$.isFunction(value)){throw new Error('A non-function was provided for paramter "'+valueName+'", but a function is required. '+"Actual value passed: "+value);
}};
TelephonyUtil.substituteString=function(string,valueMap){for(var key in valueMap){if(valueMap.hasOwnProperty(key)){string=string.replace("${"+key+"}",valueMap[key]);
}}return string;
};
})(jQuery);
(function(){var DEFAULT_MAX_RETRIES=3;
var DEFAULT_RETRY_DELAY=2000;
var DEFAULT_BACKOFF_FUNCTION_NAME="constant";
if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.tel=="undefined"){amzn.tel={};
}if(typeof amzn.tel.retry=="undefined"){amzn.tel.retry={};
}function now(){return new Date().getTime();
}amzn.tel.retry.doTaskWithRetries=function(namedArgs){var task=namedArgs.task;
var maxRetries=namedArgs.maxRetries;
var retryDelay=namedArgs.retryDelay||DEFAULT_RETRY_DELAY;
var backoff=namedArgs.backoff||DEFAULT_BACKOFF_FUNCTION_NAME;
var retryTimeLimit=namedArgs.retryTimeLimit;
var clientFailHandler=namedArgs.onFail||function(){};
var clientSuccessHandler=namedArgs.onSuccess||function(){};
var clientGiveUpHandler=namedArgs.onGiveUp||function(){};
if(typeof maxRetries=="undefined"||(maxRetries==null&&!retryTimeLimit)){maxRetries=DEFAULT_MAX_RETRIES;
}var backoffFunc=amzn.tel.retry.backoffFuncs[backoff];
var attemptNumber=0;
var firstTryAttemptTime=now();
var taskDone=function(success,nextRetryDelay){if(typeof nextRetryDelay!="undefined"){retryDelay=nextRetryDelay;
}if(success){return clientSuccessHandler();
}else{var isOverTimeLimit=!!retryTimeLimit&&now()-firstTryAttemptTime>retryTimeLimit;
var maxRetriesReached=maxRetries!==null&&attemptNumber>=maxRetries;
attemptNumber++;
clientFailHandler(attemptNumber);
if(maxRetriesReached||isOverTimeLimit){return clientGiveUpHandler();
}else{var waitTime=retryDelay+backoffFunc(attemptNumber,retryDelay);
window.setTimeout(function(){task(taskDone,attemptNumber);
},waitTime);
}}};
return task(taskDone,attemptNumber);
};
amzn.tel.retry.backoffFuncs={exponential:function(attemptNumber,retryDelay){return Math.pow(retryDelay,attemptNumber)-retryDelay;
},linear:function(attemptNumber,retryDelay){return(attemptNumber-1)*retryDelay;
},constant:function(attemptNumber,retryDelay){return retryDelay;
}};
})();
if(!this.JSON){this.JSON={};
}(function(){function f(n){return n<10?"0"+n:n;
}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null;
};
String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();
};
}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;
function quote(string){escapable.lastIndex=0;
return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];
return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);
})+'"':'"'+string+'"';
}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];
if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key);
}if(typeof rep==="function"){value=rep.call(holder,key,value);
}switch(typeof value){case"string":return quote(value);
case"number":return isFinite(value)?String(value):"null";
case"boolean":case"null":return String(value);
case"object":if(!value){return"null";
}gap+=indent;
partial=[];
if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;
for(i=0;
i<length;
i+=1){partial[i]=str(i,value)||"null";
}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";
gap=mind;
return v;
}if(rep&&typeof rep==="object"){length=rep.length;
for(i=0;
i<length;
i+=1){k=rep[i];
if(typeof k==="string"){v=str(k,value);
if(v){partial.push(quote(k)+(gap?": ":":")+v);
}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);
if(v){partial.push(quote(k)+(gap?": ":":")+v);
}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";
gap=mind;
return v;
}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;
gap="";
indent="";
if(typeof space==="number"){for(i=0;
i<space;
i+=1){indent+=" ";
}}else{if(typeof space==="string"){indent=space;
}}rep=replacer;
if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify");
}return str("",{"":value});
};
}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;
function walk(holder,key){var k,v,value=holder[key];
if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);
if(v!==undefined){value[k]=v;
}else{delete value[k];
}}}}return reviver.call(holder,key,value);
}cx.lastIndex=0;
if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);
});
}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");
return typeof reviver==="function"?walk({"":j},""):j;
}throw new SyntaxError("JSON.parse");
};
}}());
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.coraljsonp=="undefined"){amzn.coraljsonp={};
}var DEFAULT_TIMEOUT=6000;
var corsSupported=window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest();
if(navigator.userAgent.indexOf("Trident")!==-1){corsSupported=false;
}amzn.coraljsonp.queryService=function(namedArgs){namedArgs=namedArgs||{};
var params=namedArgs.params||{};
var url=namedArgs.url||"";
var clientSuccessHandler=namedArgs.onSuccess||function(){};
var clientErrorHandler=namedArgs.onError||function(){};
var clientCompleteHandler=namedArgs.onComplete||function(){};
var resultNestedLocation=namedArgs.resultNestedLocation||[];
var requiredKeys=namedArgs.requiredKeys||[];
var operation=namedArgs.operation||"";
var isCoral=(typeof namedArgs.isCoral==="undefined")?true:namedArgs.isCoral;
var crossDomain=(typeof namedArgs.crossDomain=="undefined")?true:namedArgs.crossDomain;
var crossDomainXhrEnabled=crossDomain&&namedArgs.crossDomainXhrEnabled&&corsSupported;
var timeout=(typeof namedArgs.timeout==="undefined")?DEFAULT_TIMEOUT:namedArgs.timeout;
var log=namedArgs.logger;
var jsonpChannel=namedArgs.jsonpChannel;
if(!log){if(typeof amzn!="undefined"&&amzn.cs&&amzn.cs.log){log=amzn.cs.log.getLogger("coraljsonp");
}else{if(typeof console!="undefined"&&console.debug&&console.error){log=console;
}else{log={debug:function(){},error:function(){}};
}}}var useJsonp=crossDomain&&!crossDomainXhrEnabled;
if(isCoral){params.Operation=operation;
params.ContentType="JSON";
if(useJsonp){params.JSONCallBack="?";
}}var failed=false;
var handleError=function(xhr,status,error,code){failed=true;
var errorHandled=clientErrorHandler(xhr,status,error,code);
clientCompleteHandler();
if(!errorHandled){if(code){log.error("Modelled error. Code:",code);
}else{var trimmedXhr=TelephonyUtil.trimXHR(xhr);
log.error("AJAX error. Status:",status," Error:",error," XHR:",trimmedXhr);
}}};
var requestDescriptor=url;
if(operation){requestDescriptor=requestDescriptor+"|"+operation;
}log.debug("Requesting "+requestDescriptor);
var crossDomainXhr=null;
var ajaxCallId=amzn.coraljsonp._registerAjaxCall({log:log,requestDescriptor:requestDescriptor,timeoutMs:timeout,timeoutHandler:function(){handleError(crossDomainXhr,"timeout","Call to "+requestDescriptor+" timed out after "+timeout+" ms");
if(crossDomainXhr){crossDomainXhr.abort();
}}});
var startTime=new Date().getTime();
if(amzn.coraljsonp.doh){url+="http://www.dooooooooooooooooooooh.com";
}var ajaxOptions={url:url,data:params,cache:false,dataType:useJsonp?"jsonp":"json",jsonp:isCoral?"JSONCallBack":"callback",success:function(response,status,xhr){if(failed){return;
}amzn.coraljsonp._markAjaxCallReceived(ajaxCallId);
var callTime=new Date().getTime()-startTime;
if(!operation){var parts=url.split(/:\/\/[\w\.:]+/);
operation=parts.length==2?parts[1]:url;
}log.debug("Response for "+operation,"("+callTime+" ms)");
if(response.Error&&response.Error.Code){handleError(null,null,null,response.Error.Code);
}else{var onMissingKey=function(missingKey){handleError(null,null,"Missing key: "+missingKey);
};
response=amzn.coraljsonp._drillIntoResult(response,resultNestedLocation,requiredKeys,onMissingKey);
if(response!==null){clientSuccessHandler(response,status);
clientCompleteHandler();
}}},error:function(xhr,status,error){amzn.coraljsonp._markAjaxCallReceived(ajaxCallId);
handleError(xhr,status,error);
}};
if(useJsonp&&jsonpChannel){ajaxOptions.iframeName=amzn.coraljsonp._getChannelIFrameName(jsonpChannel);
ajaxOptions.logger=log;
amzn.coraljsonp._jsonpInIFrame(ajaxOptions);
}else{if(crossDomainXhrEnabled){crossDomainXhr=amzn.coraljsonp._sendCrossDomainXhr(ajaxOptions);
}else{$.ajax(ajaxOptions);
}}};
amzn.coraljsonp._sendCrossDomainXhr=function(args){var xhr=new XMLHttpRequest();
var url=args.url;
var data=args.data||{};
var onError=args.error||function(){};
var onSuccess=args.success||function(){};
if(!url){throw"url param required";
}xhr.onreadystatechange=function(){if(xhr.readyState!=4){return;
}if(xhr.status!=200){onError(xhr,"error",xhr.statusText);
return;
}var response;
try{response=JSON.parse(xhr.responseText);
}catch(e){onError(xhr,"parseerror",e);
return;
}onSuccess(response,xhr.statusText,xhr);
};
xhr.open("POST",url);
xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xhr.send($.param(data));
};
amzn.coraljsonp.cleanupChannel=function(channelName){var log=amzn.cs.log.getLogger("coraljsonp");
try{var name=amzn.coraljsonp._getChannelIFrameName(channelName);
$('iframe[name="'+name+'"]').remove();
delete window.frames[name];
}catch(e){log.error("Error cleaning up channel",channelName,e);
}};
amzn.coraljsonp._getChannelIFrameName=function(channelName){return"jsonpChannel-"+channelName;
};
$.coraljsonp=amzn.coraljsonp.queryService;
amzn.coraljsonp._jsonpInIFrame=function(args){var iframeName=args.iframeName;
if(!iframeName){throw new Error("no iframe name given");
}iframe=window.frames[iframeName];
if(!iframe){iframe=document.createElement("iframe");
iframe.name=iframeName;
iframe.style.display="none";
if(TelephonyUtil.isIE6){iframe.src="javascript:false;";
}document.body.appendChild(iframe);
}window.setTimeout(function(){amzn.coraljsonp._jsonp($.extend({},args,{iframeName:iframeName}));
},0);
};
var jsonpSeq=new Date().getTime();
amzn.coraljsonp._jsonp=function(args){var opts=$.extend({cache:true,data:{},success:function(){},url:"",jsonp:"callback",scriptCharset:null,iframeName:null},args);
var log=args.log||amzn.cs.log.getLogger("coraljsonp");
var iframe;
if(opts.iframeName){iframe=window.frames[opts.iframeName];
}var doc=(iframe||window).document;
if(opts.cache){opts.data._=new Date().getTime();
}var callbackName="amznjsonp"+jsonpSeq++;
opts.data[opts.jsonp]=iframe?"parent."+callbackName:callbackName;
var url=opts.url+"?"+$.param(opts.data);
var script=doc.createElement("script");
script.src=url;
if(opts.scriptCharset){script.charset=scriptCharset;
}window[callbackName]=function(resp){try{opts.success(resp);
}finally{window.setTimeout(function(){window[callbackName]=undefined;
try{delete window[callbackName];
}catch(e){}doc.body.removeChild(script);
},5000);
}};
doc.body.appendChild(script);
};
amzn.coraljsonp._drillIntoResult=function(data,nestedLocation,requiredKeys,onMissingKey){var missingKey,i,key;
for(i=0;
i<nestedLocation.length;
i++){key=nestedLocation[i];
if(typeof data[key]=="undefined"){onMissingKey(key);
return null;
}else{data=data[key];
}}if(requiredKeys&&typeof missingKey=="undefined"){for(i=0;
i<requiredKeys.length;
i++){key=requiredKeys[i];
if(typeof data[key]=="undefined"){onMissingKey(key);
return null;
}}}return data;
};
amzn.coraljsonp._registerAjaxCall=function(namedArgs){var log=namedArgs.log;
var timeoutMs=namedArgs.timeoutMs;
var requestDescriptor=namedArgs.requestDescriptor;
var timeoutHandler=namedArgs.timeoutHandler||function(){};
var startTime=new Date().getTime();
var ajaxCallId=new Date().getTime()+"_"+Math.floor(Math.random()*1000000);
if(typeof amzn.coraljsonp._registeredAJAXCalls=="undefined"){amzn.coraljsonp._registeredAJAXCalls={};
}amzn.coraljsonp._registeredAJAXCalls[ajaxCallId]=1;
if(timeoutMs){var timeoutContext;
var doCheckIfTimedOut=function(lateness){if(typeof amzn.coraljsonp._registeredAJAXCalls[ajaxCallId]!="undefined"){var actualTimeDifference=new Date().getTime()-startTime;
log.debug("coraljsonp timeout detected for ajax id ",ajaxCallId,"lateness:",lateness,"timeoutMs:",timeoutMs,"diff:",actualTimeDifference,"request:",requestDescriptor,"timeoutContext:",timeoutContext);
amzn.coraljsonp._markAjaxCallReceived(ajaxCallId);
timeoutHandler();
}};
timeoutContext=TelephonyUtil.setTimeout(doCheckIfTimedOut,timeoutMs);
}return ajaxCallId;
};
amzn.coraljsonp._markAjaxCallReceived=function(ajaxCallId){if(typeof amzn.coraljsonp._registeredAJAXCalls!="undefined"){delete amzn.coraljsonp._registeredAJAXCalls[ajaxCallId];
}};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.cstel=="undefined"){amzn.cstel={};
}var DEFAULT_MAX_RETRIES=2;
var DEFAULT_RETRY_DELAY=1000;
amzn.cstel.BaseServiceClient=function(options){options=options?options:{};
this.options=$.extend({serviceEnv:"prod",serviceGeo:"na",serviceHost:null,logger:null,serviceHosts:{test:{na:"",eu:"",fe:"",cn:""},master:{na:"",eu:"",fe:"",cn:""},prod:{na:"",eu:"",fe:"",cn:""}}},options);
this._log=this.options.logger||amzn.cs.log.getLogger("baseclient");
if(!this.options.serviceHost){this.baseServiceUrl=this.options.serviceHosts[this.options.serviceEnv][this.options.serviceGeo];
}else{this.baseServiceUrl=this.options.serviceHost;
}this._cache=TelephonyUtil.createMapCache();
};
var defaultIsUserErrorCode=function(code){return !code.match(/(Timeout)/);
};
amzn.cstel.BaseServiceClient.prototype._requestJson=function(args){var self=this;
args=$.extend({isCoral:false,isUserErrorCode:defaultIsUserErrorCode,retryDelay:DEFAULT_RETRY_DELAY,maxRetries:DEFAULT_MAX_RETRIES,retryTimeLimit:null,onSuccess:function(){}},args);
var url=this.baseServiceUrl;
if(args.url){url+=args.url;
}var errorArgs=[];
var cacheTime=args.cacheTime;
if(cacheTime){var cacheKey=url+"?"+$.param(args.params);
var cachedResult=this._cache.get(cacheKey);
if(cachedResult){if(args.onCacheHit){args.onCacheHit();
}args.onSuccess(cachedResult);
return;
}if(args.onCacheMiss){args.onCacheMiss();
}}var task=function(taskDone){$.coraljsonp({params:args.params,url:url,operation:args.operation,resultNestedLocation:args.resultNestedLocation,requiredKeys:args.requiredKeys,timeout:args.timeout,logger:self.options.logger,onComplete:args.onComplete,isCoral:args.isCoral,crossDomainXhrEnabled:args.crossDomainXhrEnabled,jsonpChannel:args.jsonpChannel,onSuccess:function(response){taskDone(true);
if(args.onSuccess){args.onSuccess.apply(this,arguments);
}if(args.cacheTime){self._cache.put(cacheKey,response,args.cacheTime);
}},onError:function(xhr,status,message,code){if(code&&args.isUserErrorCode(code)){taskDone(true);
if(args.onError){return args.onError.apply(this,arguments);
}}else{errorArgs=arguments;
var nextTryDelay=status=="timeout"?0:args.retryDelay;
return taskDone(false,nextTryDelay);
}}});
};
amzn.tel.retry.doTaskWithRetries({maxRetries:args.maxRetries,retryDelay:args.retryDelay,backoff:args.backoff,retryTimeLimit:args.retryTimeLimit,task:task,onGiveUp:function(){if(args.onError){return args.onError.apply(this,errorArgs);
}}});
};
amzn.cstel.BaseServiceClient.prototype._requestCoralJson=function(args){var hasResult=(typeof args.hasResult=="undefined")?true:args.hasResult;
var resultNestedLocation=[];
if(hasResult){resultNestedLocation=[args.operation+"Response",args.operation+"Result"];
if(args.resultNestedLocation){resultNestedLocation=resultNestedLocation.concat(args.resultNestedLocation);
}}args.isCoral=true;
args.resultNestedLocation=resultNestedLocation;
this._requestJson(args);
};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}var serviceHosts={test:{na:"https://c2c.integ.amazon.com",fe:"https://c2c-fe.integ.amazon.com",eu:"https://c2c-eu.integ.amazon.com",cn:"https://c2c-cn.integ.amazon.com"},master:{na:"https://c2c-preprod.amazon.com",fe:"https://c2c-fe-preprod.amazon.com",eu:"https://c2c-eu-preprod.amazon.com",cn:"https://c2c-cn-preprod.amazon.com"},prod:{na:"https://c2c.amazon.com",fe:"https://c2c-fe.amazon.com",eu:"https://c2c-eu.amazon.com",cn:"https://c2c.amazon.cn"}};
var edgeCacheVersion="@edgeCacheVersion@";
amzn.c2c.C2CServiceClient=function(options){this.constructor=amzn.c2c.C2CServiceClient;
options=options||{};
options.serviceHosts=serviceHosts;
amzn.cstel.BaseServiceClient.call(this,options);
};
amzn.c2c.C2CServiceClient.prototype=new amzn.cstel.BaseServiceClient();
amzn.c2c.C2CServiceClient.prototype.requestCallStatus=function(args){this._requestCoralJson($.extend({operation:"getCallStatus",params:{"callContextId":args.callContextId,"supportAgentJoined":true},requiredKeys:["callStatusCode"]},args));
};
amzn.c2c.C2CServiceClient.prototype.requestClick2CallStatus=function(args){if(!args.c2cId){this._log.error("missing c2cId");
args.onError();
return;
}if(!args.timezone){this._log.error("missing timezone");
args.onError();
return;
}if(!args.locale){this._log.error("missing locale");
args.onError();
return;
}var localeParts=args.locale.match(/([a-z]{2})_?([A-Z]{2})/);
if(localeParts.length<3){this._log.error("locale must match enUS or en_US format");
args.onError();
return;
}var languageCode=localeParts[1];
var countryCode=localeParts[2];
this._requestCoralJson($.extend({operation:"getClick2CallStatus",params:{"c2cId":args.c2cId,"widgetVersion":edgeCacheVersion,"timezone":args.timezone,"languageCode":languageCode,"countryCode":countryCode},resultNestedLocation:["click2CallStatus"],requiredKeys:["isSkillInOpenHours","callableCountries","hoursOfOperation"]},args));
};
amzn.c2c.C2CServiceClient.prototype.disconnectCall=function(args){this._requestCoralJson($.extend({operation:"disconnectCall",params:{"callContextId":args.contextId},hasResult:false},args));
};
amzn.c2c.C2CServiceClient.prototype.initiateCall=function(args){if(!args.contextId){this._log.warn("No contextId supplied!");
}var contextId=args.contextId;
if(!contextId||contextId.length<5){contextId="";
}args.virtualCall=!!args.virtualCall;
args.whenToCallMinutes=parseInt(args.whenToCallMinutes,10);
if(isNaN(args.whenToCallMinutes)){args.whenToCallMinutes=0;
}this._requestCoralJson($.extend({operation:"initiateCall",maxRetries:0,timeout:6000,params:{"c2cId":args.c2cId,"callAfterMins":args.whenToCallMinutes,"userCallbackNumber.phoneNumber":args.phoneNumber,"userCallbackNumber.country":args.countryCode,"userCallbackNumber.extensionDetails.extension":args.extension,"userCallbackNumber.extensionDetails.routeThroughReceptionist":args.viaReceptionist,"callContextId":contextId,"virtualCall":args.virtualCall}},args));
};
amzn.c2c.C2CServiceClient.prototype.initiateChat=function(args){if(!args.contextId){this._log.warn("No contextId supplied!");
}var contextId=args.contextId;
if(!contextId||contextId.length<5){contextId="";
}var params={"c2cId":args.c2cId,"contextId":contextId,"userInfo.name":args.userName,"userInfo.email":args.userEmail,"userInfo.initialQuestion":args.userInitialQuestion};
if(args.reconnectToken){params.reconnectToken=args.reconnectToken;
}if(args.reconnectReasonDebugMessage){params.reconnectReasonDebugMessage=args.reconnectReasonDebugMessage;
}this._requestCoralJson($.extend({operation:"initiateChat",params:params,requiredKeys:["chatLegId","topicUrl","keepAliveInterval"]},args));
};
amzn.c2c.C2CServiceClient.prototype.initiateWorkItem=function(args){var contextId=args.contextId;
if(!contextId||contextId.length<5){contextId="";
}var params={"c2cId":args.c2cId,"contextId":contextId};
this._requestCoralJson($.extend({operation:"initiateWorkItem",params:params,requiredKeys:["workItemId","contextId"]},args));
};
amzn.c2c.C2CServiceClient.prototype.emailChatTranscript=function(args){var params={"chatIds":args.chatIds,"c2cId":args.c2cId,"transcriptToken":args.transcriptToken};
this._requestCoralJson($.extend({operation:"emailChatTranscript",params:params,hasResult:false},args));
};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.cs=="undefined"){amzn.cs={};
}if(typeof amzn.cs.util=="undefined"){amzn.cs.util={};
}$.fn.amznSafeShow=function(settings){if(!settings){settings={};
}var animate=typeof settings.animate=="undefined"?true:settings.animationEnabled;
var durationMs=settings.durationMs||500;
var easingFunction=settings.easingFunction||"linear";
return this.each(function(){var jQuerySelector=$(this);
if(!animate){$(jQuerySelector).show();
return;
}var endHeight=jQuerySelector.height();
var cssHeight=jQuerySelector.css("height");
jQuerySelector.filter(":hidden").css("height","1px").animate({height:endHeight,width:"show",opacity:"show"},durationMs,easingFunction,function(){jQuerySelector.css("height",cssHeight);
});
});
};
$.fn.amznSafeHide=function(settings){if(!settings){settings={};
}var animate=typeof settings.animate=="undefined"?true:settings.animationEnabled;
var durationMs=settings.durationMs||500;
var easingFunction=settings.easingFunction||"linear";
return this.each(function(){var jQuerySelector=$(this);
if(!animate){$(jQuerySelector).hide();
return;
}var cssHeight=jQuerySelector.css("height");
jQuerySelector.filter(":visible").animate({height:"1px",width:"hide",opacity:"hide"},durationMs,easingFunction,function(){jQuerySelector.hide().css("height",cssHeight);
});
});
};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}var FIELD_WIDTH_MAX=12;
var phoneInputElem=document.createElement("input");
phoneInputElem.setAttribute("type","tel");
var phoneInputType=(phoneInputElem.type!=="text")?"tel":"text";
amzn.c2c.PhoneNumberField=function(format,c2cWidget){this.c2cWidget=c2cWidget;
if(format){this.minDigits=format.minLength;
this.maxDigits=format.maxLength;
var country=c2cWidget._getCurrentCountry();
var domElem=document.createElement("input");
domElem.id="c2c-yournumber-"+c2cWidget.getInstanceId();
domElem.className="c2c-yournumber";
domElem.type=phoneInputType;
if(this.enforcesMaxDigits()){domElem.maxLength=this.maxDigits;
}if(country===amzn.c2c.OTHER_COUNTRY_CODE){$(domElem).addClass("c2c-yournumber-othercountry");
}else{var fieldWidth=Math.min(this.maxDigits,FIELD_WIDTH_MAX);
domElem.style.width=fieldWidth+"em";
}domElem.title=c2cWidget.getString("yourNumberTip");
var fieldObj=this;
domElem.getFieldObject=function(){return fieldObj;
};
this.domElem=domElem;
}};
amzn.c2c.PhoneNumberField.prototype.getDomElement=function(){return this.domElem;
};
amzn.c2c.PhoneNumberField.prototype.getValue=function(){return this.domElem.value;
};
amzn.c2c.PhoneNumberField.prototype.getMinDigits=function(){return this.minDigits;
};
amzn.c2c.PhoneNumberField.prototype.getMaxDigits=function(){return this.maxDigits;
};
amzn.c2c.DividedPhoneNumberField=function(format,c2cWidget){this.constructor=amzn.c2c.DividedPhoneNumberField;
amzn.c2c.PhoneNumberField.call(this,format,c2cWidget);
};
amzn.c2c.DividedPhoneNumberField.prototype=new amzn.c2c.PhoneNumberField();
amzn.c2c.DividedPhoneNumberField.prototype.enforcesMaxDigits=function(){return true;
};
amzn.c2c.DividedPhoneNumberField.prototype.validate=function(){var errors=[];
if(!this.getValue().match(/^\d*$/)){errors.push(new amzn.c2c.InvalidCharsValidationError(this,this.c2cWidget));
}if(this.getValue().length<this.minDigits){errors.push(new amzn.c2c.TooShortValidationError(this,this.c2cWidget));
}return errors;
};
amzn.c2c.SinglePhoneNumberField=function(format,c2cWidget){this.constructor=amzn.c2c.SinglePhoneNumberField;
amzn.c2c.PhoneNumberField.call(this,format,c2cWidget);
var countryCode=c2cWidget._getCurrentCountryConfig().countryCode;
if(amzn.c2c.leadingZeroPrefixCountries[countryCode]){this.stripLeadingZeros=false;
}else{this.stripLeadingZeros=true;
}$(this.getDomElement()).addClass("c2c-yournumber-singlefield");
};
amzn.c2c.SinglePhoneNumberField.prototype=new amzn.c2c.PhoneNumberField();
amzn.c2c.SinglePhoneNumberField.prototype.enforcesMaxDigits=function(){return false;
};
amzn.c2c.SinglePhoneNumberField.prototype.getValue=function(){var val=this.domElem.value.replace(/[^\d]/g,"");
if(this.stripLeadingZeros){val=val.replace(/^0+/,"");
}return val;
};
amzn.c2c.SinglePhoneNumberField.prototype.validate=function(){var errors=[];
if(this.getValue().length<this.minDigits){errors.push(new amzn.c2c.TooShortValidationError(this,this.c2cWidget));
}if(this.getValue().length>this.maxDigits){errors.push(new amzn.c2c.TooLongValidationError(this,this.c2cWidget));
}return errors;
};
amzn.c2c.ValidationError=function(fieldInError,message){this.message=message;
this.fieldInError=fieldInError;
};
amzn.c2c.ValidationError.prototype.getMessage=function(){return this.message;
};
amzn.c2c.ValidationError.prototype.getFieldInError=function(){return this.fieldInError;
};
amzn.c2c.TooLongValidationError=function(fieldInError,c2cWidget){this.constructor=amzn.c2c.TooLongValidationError;
amzn.c2c.ValidationError.call(this,fieldInError,c2cWidget.getString("tooLongError").replace(/%s/,fieldInError.getMaxDigits()));
};
amzn.c2c.TooLongValidationError.prototype=new amzn.c2c.ValidationError();
amzn.c2c.TooShortValidationError=function(fieldInError,c2cWidget){this.constructor=amzn.c2c.TooShortValidationError;
amzn.c2c.ValidationError.call(this,fieldInError,c2cWidget.getString("tooShortError").replace(/%s/,fieldInError.getMinDigits()));
};
amzn.c2c.TooShortValidationError.prototype=new amzn.c2c.ValidationError();
amzn.c2c.InvalidCharsValidationError=function(fieldInError,c2cWidget){this.constructor=amzn.c2c.InvalidCharsValidationError;
amzn.c2c.ValidationError.call(this,fieldInError,c2cWidget.getString("invalidCharsError"));
};
amzn.c2c.InvalidCharsValidationError.prototype=new amzn.c2c.ValidationError();
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}var dayToDayNum={"Monday":0,"Tuesday":1,"Wednesday":2,"Thursday":3,"Friday":4,"Saturday":5,"Sunday":6};
$.fn.amznHoursOfOperationUI=function(options){return this.each(function(){var container=this;
var ui=new amzn.c2c.HoursOfOperationUI(container,options);
});
};
amzn.c2c.HoursOfOperationUI=function(container,options){this.options=$.extend({timezone:"America/Los_Angeles",showTimeZone:true,hours:[]},options);
this.strings=$.extend({openAllDayHours:"Open all day",dayRangeDelimiter:"-",dayRangeTerminator:":",hourRangeDelimiter:" - ",hourRangeListDelimiter:", ",am:"AM",pm:"PM",midnight:"Midnight",noon:"Noon",everyDayOfTheWeek:"Every day of the week",dayNameMonday:"Monday",dayNameTuesday:"Tuesday",dayNameWednesday:"Wednesday",dayNameThursday:"Thursday",dayNameFriday:"Friday",dayNameSaturday:"Saturday",dayNameSunday:"Sunday","tzNameAmerica/Los_Angeles":"Pacific","tzNameEurope/London":"London","tzNameEurope/Paris":"Paris","tzNameEurope/Berlin":"Berlin","tzNameAsia/Tokyo":"Tokyo"},options.strings);
this._render(container);
};
amzn.c2c.HoursOfOperationUI.prototype._render=function(container){var collapsedHoursByDays=this._collapseDailyHours(this.options.hours);
$(container).empty();
for(var lineNum=0;
lineNum<collapsedHoursByDays.length;
lineNum++){var startDay=collapsedHoursByDays[lineNum].startDay;
var endDay=collapsedHoursByDays[lineNum].endDay;
var hours=collapsedHoursByDays[lineNum].hours;
$(container).append('<div class="c2c-hours-row">'+'<span class="c2c-day-range">'+this._formatDayRange(startDay,endDay)+"</span>"+'<span class="c2c-hour-range">'+this._formatHours(hours)+"</span>"+"</div>");
}};
amzn.c2c.HoursOfOperationUI.prototype._areHoursEqual=function(h1,h2){if(h1.length!=h2.length){return false;
}for(var rangeNum=0;
rangeNum<h1.length;
rangeNum++){if(h1[rangeNum].startHour!=h2[rangeNum].startHour){return false;
}if(h1[rangeNum].endHour!=h2[rangeNum].endHour){return false;
}}return true;
};
amzn.c2c.HoursOfOperationUI.prototype._collapseDailyHours=function(hoursForDayList){hoursForDayList.sort(function(a,b){return dayToDayNum[a.dayName]-dayToDayNum[b.dayName];
});
var collapsedList=[];
for(var addMe;
(addMe=hoursForDayList.shift());
){var lastCollapsedItem=collapsedList[collapsedList.length-1];
var dayGap=1;
if(lastCollapsedItem){dayGap=dayToDayNum[addMe.dayName]-dayToDayNum[lastCollapsedItem.endDay||lastCollapsedItem.startDay];
}if(lastCollapsedItem&&dayGap==1&&this._areHoursEqual(lastCollapsedItem.hours,addMe.operationTimeSlices)){lastCollapsedItem.endDay=addMe.dayName;
}else{collapsedList.push({startDay:addMe.dayName,endDay:null,hours:addMe.operationTimeSlices});
}}return collapsedList;
};
amzn.c2c.HoursOfOperationUI.prototype._formatHour=function(localizedHour,rawHour){if(rawHour==="0000"&&this.strings.midnight){return this.strings.midnight;
}else{if(rawHour==="1200"&&this.strings.noon){return this.strings.noon;
}else{return localizedHour.replace(/AM/,this.strings.am).replace(/PM/,this.strings.pm);
}}};
amzn.c2c.HoursOfOperationUI.prototype._formatHours=function(hourRanges){var rangeStrings=[];
var openAllDay=false;
for(var rangeNum=0;
rangeNum<hourRanges.length;
rangeNum++){var startHour=hourRanges[rangeNum].startHour;
var endHour=hourRanges[rangeNum].endHour;
var startHourRaw=hourRanges[rangeNum].startHourRaw;
var endHourRaw=hourRanges[rangeNum].endHourRaw;
if(typeof startHour=="string"&&startHour===endHour){rangeStrings.push(this.strings.openAllDayHours);
openAllDay=true;
}else{startHour=this._formatHour(startHour,startHourRaw);
endHour=this._formatHour(endHour,endHourRaw);
rangeStrings.push(startHour+this.strings.hourRangeDelimiter+endHour);
}}if(!openAllDay&&rangeStrings){rangeStrings[rangeStrings.length-1]+=this._formatTimeZone(this.options.timezone);
}var self=this;
rangeStrings=$.map(rangeStrings,function(range,i){var text=range;
if(i<rangeStrings.length-1){text+=self.strings.hourRangeListDelimiter;
}return'<span class="c2c-hour-range-line">'+text+"</span>";
});
return rangeStrings.join("");
};
amzn.c2c.HoursOfOperationUI.prototype._formatDayRange=function(startDay,endDay){var result;
if(dayToDayNum[startDay]===0&&dayToDayNum[endDay]===6&&this.strings.everyDayOfTheWeek){result=this.strings.everyDayOfTheWeek;
}else{result=this.strings["dayName"+startDay];
if(endDay){result+=(this.strings.dayRangeDelimiter+this.strings["dayName"+endDay]);
}}return result+this.strings.dayRangeTerminator;
};
amzn.c2c.HoursOfOperationUI.prototype._formatTimeZone=function(timezone){var tzString=this.strings["tzName"+timezone];
if(this.options.showTimeZone&&tzString){return" ("+tzString+")";
}else{return"";
}};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}var CACHE_TIME=60000;
amzn.c2c.C2CStatusChecker=function(options){this.options=$.extend({c2cId:null,timezone:"America/Los_Angeles",locale:"enUS",serviceEnv:"test",serviceGeo:"na",onError:function(){},cache:true,onCacheMiss:function(){},onCacheHit:function(){},alwaysLookupHours:false,onOutOfHours:function(hours,status){},onDisabled:function(hours,status){},onNoAgents:function(hours,status){},onAvailable:function(waitTime,hours,status){},fakeInHours:false,fakeOutOfHours:false,fakeAgentsAvail:false,fakeAgentsUnavail:false,logger:null,debug:true},options);
this.options.c2cId=TelephonyUtil.sanitizeGUID(this.options.c2cId);
this.cacheTime=this.options.cache?CACHE_TIME:0;
this._log=this.options.logger;
if(!this._log){this._log=amzn.cs.log.getLogger("C2CStatusChecker");
this._log.setPrefix("[C2CStatusChecker]");
this._log.setLevel(this.options.debug?"DEBUG":"WARN");
}this._c2cClient=new amzn.c2c.C2CServiceClient({serviceHost:this.options.c2cServiceHostOverride,serviceEnv:this.options.serviceEnv,serviceGeo:this.options.serviceGeo,logger:this._log});
};
amzn.c2c.C2CStatusChecker.prototype.setC2CId=function(c2cId){this.options.c2cId=c2cId;
};
amzn.c2c.C2CStatusChecker.prototype.checkNow=function(){var self=this;
this._lookupStatus(function(status){var outOfHours=!(status.isSkillInOpenHours||self.options.fakeInHours)||self.options.fakeOutOfHours;
var agentsUnavail=!(status.areAgentsAvailable||self.options.fakeAgentsAvail)||self.options.fakeAgentsUnavail;
if(!status.c2cEnabled){self.options.onDisabled(status.hoursOfOperation,status);
}else{if(outOfHours){self.options.onOutOfHours(status.hoursOfOperation,status);
}else{if(agentsUnavail){self.options.onNoAgents(status.hoursOfOperation,status);
}else{var waitTime=null;
if(status.queueTime&&status.queueTime.available){waitTime=status.queueTime.waitTime;
}self.options.onAvailable(waitTime,status.hoursOfOperation,status);
}}}});
};
amzn.c2c.C2CStatusChecker.prototype.startPeriodicCheck=function(intervalSecs){this.stopPeriodicCheck();
intervalSecs=intervalSecs||350;
var self=this;
this._hoursCheckInterval=window.setInterval(function(){self.checkNow();
},intervalSecs*1000);
};
amzn.c2c.C2CStatusChecker.prototype.stopPeriodicCheck=function(){window.clearInterval(this._hoursCheckInterval);
};
amzn.c2c.C2CStatusChecker.prototype._lookupStatus=function(onSuccess){var self=this;
this._c2cClient.requestClick2CallStatus({c2cId:this.options.c2cId,locale:this.options.locale,timezone:this.options.timezone,cacheTime:this.cacheTime,onCacheMiss:this.options.onCacheMiss,onCacheHit:this.options.onCacheHit,onSuccess:onSuccess,onError:function(xhr,status,message,code){self.options.onError(xhr,status,message,code);
}});
};
})(jQuery);
/*! ################################################################
 *  Masked Input plugin for jQuery
 *  Copyright (c) 2007-2011 Josh Bush (digitalbush.com)
 *  Licensed under the MIT license (  http://digitalbush.com/projects/masked-input-plugin/#license  )
 *  This code is modified by Amazon to stop erasing value on invalid input.
 *  Version: 1.3
 * ################################################################
 */
(function($){var pasteEventName=($.browser.msie?"paste":"input")+".mask";
var iPhone=(window.orientation!==undefined);
var maskDefinition={definitions:{"9":"[0-9]","a":"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"};
$.fn.extend({caret:function(begin,end){if(this.length===0){return;
}if(typeof begin=="number"){end=(typeof end=="number")?end:begin;
return this.each(function(){if(this.setSelectionRange){this.setSelectionRange(begin,end);
}else{if(this.createTextRange){var range=this.createTextRange();
range.collapse(true);
range.moveEnd("character",end);
range.moveStart("character",begin);
range.select();
}}});
}else{if(this[0].setSelectionRange){begin=this[0].selectionStart;
end=this[0].selectionEnd;
}else{if(document.selection&&document.selection.createRange){var range=document.selection.createRange();
begin=0-range.duplicate().moveStart("character",-100000);
end=begin+range.text.length;
}}return{begin:begin,end:end};
}},unmask:function(){return this.trigger("unmask");
},mask:function(mask,settings){if(!mask&&this.length>0){var input=$(this[0]);
return input.data(maskDefinition.dataName)();
}settings=$.extend({placeholder:"_",completed:null},settings);
var defs=maskDefinition.definitions;
var tests=[];
var partialPosition=mask.length;
var firstNonMaskPos=null;
var len=mask.length;
$.each(mask.split(""),function(i,c){if(c=="?"){len--;
partialPosition=i;
}else{if(defs[c]){tests.push(new RegExp(defs[c]));
if(firstNonMaskPos==null){firstNonMaskPos=tests.length-1;
}}else{tests.push(null);
}}});
return this.trigger("unmask").each(function(){var input=$(this);
var buffer=$.map(mask.split(""),function(c,i){if(c!="?"){return defs[c]?settings.placeholder:c;
}});
var focusText=input.val();
function seekNext(pos){while(++pos<=len&&!tests[pos]){}return pos;
}function seekPrev(pos){while(--pos>=0&&!tests[pos]){}return pos;
}function shiftL(begin,end){if(begin<0){return;
}for(var i=begin,j=seekNext(end);
i<len;
i++){if(tests[i]){if(j<len&&tests[i].test(buffer[j])){buffer[i]=buffer[j];
buffer[j]=settings.placeholder;
}else{break;
}j=seekNext(j);
}}writeBuffer();
input.caret(Math.max(firstNonMaskPos,begin));
}function shiftR(pos){for(var i=pos,c=settings.placeholder;
i<len;
i++){if(tests[i]){var j=seekNext(i);
var t=buffer[i];
buffer[i]=c;
if(j<len&&tests[j].test(t)){c=t;
}else{break;
}}}}function keydownEvent(e){var k=e.which;
if(k==8||k==46||(iPhone&&k==127)){var pos=input.caret(),begin=pos.begin,end=pos.end;
if(end-begin===0){begin=k!=46?seekPrev(begin):(end=seekNext(begin-1));
end=k==46?seekNext(end):end;
}clearBuffer(begin,end);
shiftL(begin,end-1);
return false;
}else{if(k==27){input.val(focusText);
input.caret(0,checkVal());
return false;
}}}function keypressEvent(e){var k=e.which,pos=input.caret();
if(e.ctrlKey||e.altKey||e.metaKey||k<32){return true;
}else{if(k){if(pos.end-pos.begin!==0){clearBuffer(pos.begin,pos.end);
shiftL(pos.begin,pos.end-1);
}var p=seekNext(pos.begin-1);
if(p<len){setTimeout(function(){var c=String.fromCharCode(k);
if(tests[p].test(c)){shiftR(p);
buffer[p]=c;
writeBuffer();
var next=seekNext(p);
input.caret(next);
if(settings.completed&&next>=len){settings.completed.call(input);
}}},0);
}return false;
}}}function clearBuffer(start,end){for(var i=start;
i<end&&i<len;
i++){if(tests[i]){buffer[i]=settings.placeholder;
}}}function writeBuffer(){return input.val(buffer.join("")).val();
}function checkVal(allow){var test=input.val();
var lastMatch=-1;
for(var i=0,pos=0;
i<len;
i++){if(tests[i]){buffer[i]=settings.placeholder;
while(pos++<test.length){var c=test.charAt(pos-1);
if(tests[i].test(c)){buffer[i]=c;
lastMatch=i;
break;
}}if(pos>test.length){break;
}}else{if(buffer[i]==test.charAt(pos)&&i!=partialPosition){pos++;
lastMatch=i;
}}}if(!allow&&lastMatch+1<partialPosition){input.val("");
clearBuffer(0,len);
}else{if(allow||lastMatch+1>=partialPosition){writeBuffer();
if(!allow){input.val(input.val().substring(0,lastMatch+1));
}}}return(partialPosition?i:firstNonMaskPos);
}input.data(maskDefinition.dataName,function(){return $.map(buffer,function(c,i){return tests[i]&&c!=settings.placeholder?c:null;
}).join("");
});
if(!input.attr("readonly")){input.one("unmask",function(){input.unbind(".mask").removeData(maskDefinition.dataName);
}).bind("focus.mask",function(){focusText=input.val();
var pos=checkVal(true);
writeBuffer();
var moveCaret=function(){if(pos==mask.length){input.caret(0,pos);
}else{input.caret(pos);
}};
($.browser.msie?moveCaret:function(){setTimeout(moveCaret,0);
})();
}).bind("blur.mask",function(){checkVal(true);
if(input.val()!=focusText){input.change();
}}).bind("keydown.mask",keydownEvent).bind("keypress.mask",keypressEvent).bind(pasteEventName,function(){setTimeout(function(){input.caret(checkVal(true));
},0);
});
}checkVal();
});
}});
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}amzn.c2c.AudioInputMeter=function(canvasId,canvasWidth,canvasHeight,audioContext){if(typeof(audioContext)=="undefined"||typeof(canvasWidth)=="undefined"||typeof(canvasHeight)=="undefined"||typeof(audioContext)=="undefined"){throw new Error("Invalid parameters to Audio Input Meter");
}this.canvasId=canvasId;
this.audioMeterContext=audioContext;
this.localStream=null;
this.audioMeter=null;
this.canvasContext=null;
this.AUDIO_METER_WIDTH=canvasWidth;
this.AUDIO_METER_HEIGHT=canvasHeight;
this.mediaStreamSource=null;
this.localStream=null;
};
amzn.c2c.AudioInputMeter.prototype.turnOnAudioMeter=function(stream){this.animationLoop=true;
this.localStream=stream;
this.mediaStreamSource=this.audioMeterContext.createMediaStreamSource(stream);
this.audioMeter=this.createAudioMeter(this.audioMeterContext);
this.mediaStreamSource.connect(this.audioMeter);
this.drawLoop();
};
amzn.c2c.AudioInputMeter.prototype.turnOffAudioMeter=function(){var meter=this;
meter.animationLoop=false;
if(meter.audioMeter){meter.audioMeter.shutdown();
}if(meter.localStream){meter.localStream.stop();
}if(meter.canvasContext){meter.canvasContext.clearRect(0,0,meter.AUDIO_METER_WIDTH,meter.AUDIO_METER_HEIGHT);
meter.canvasContext.strokeStyle="black";
meter.canvasContext.rect(0,0,meter.AUDIO_METER_WIDTH,meter.AUDIO_METER_HEIGHT);
meter.canvasContext.stroke();
}};
amzn.c2c.AudioInputMeter.prototype.createAudioMeter=function(audioContext,clipLevel,averaging,clipLag){var processor=audioContext.createScriptProcessor(512);
processor.onaudioprocess=this.volumeAudioProcess;
processor.clipping=false;
processor.lastClip=0;
processor.volume=0;
processor.clipLevel=clipLevel||0.98;
processor.averaging=averaging||0.95;
processor.clipLag=clipLag||750;
processor.connect(audioContext.destination);
processor.checkClipping=function(){if(!this.clipping){return false;
}if((this.lastClip+this.clipLag)<window.performance.now()){this.clipping=false;
}return this.clipping;
};
processor.shutdown=function(){this.disconnect();
this.onaudioprocess=null;
};
return processor;
};
amzn.c2c.AudioInputMeter.prototype.volumeAudioProcess=function(event){var buf=event.inputBuffer.getChannelData(0);
var bufLength=buf.length;
var sum=0;
var x;
for(var i=0;
i<bufLength;
i++){x=buf[i];
if(Math.abs(x)>=this.clipLevel){this.clipping=true;
this.lastClip=window.performance.now();
}sum+=x*x;
}var rms=Math.sqrt(sum/bufLength);
this.volume=Math.max(rms,this.volume*this.averaging);
};
amzn.c2c.AudioInputMeter.prototype.drawLoop=function(time){var meter=this;
var canvasObj=document.getElementById(meter.canvasId);
if(!canvasObj){return;
}if(meter.animationLoop){meter.canvasContext=canvasObj.getContext("2d");
meter.canvasContext.clearRect(0,0,meter.AUDIO_METER_WIDTH,meter.AUDIO_METER_HEIGHT);
if(meter.audioMeter.checkClipping()){meter.canvasContext.fillStyle="orange";
}else{meter.canvasContext.fillStyle="orange";
}meter.canvasContext.fillRect(0,0,meter.audioMeter.volume*meter.AUDIO_METER_WIDTH*1.4,meter.AUDIO_METER_HEIGHT);
meter.canvasContext.strokeStyle="black";
meter.canvasContext.rect(0,0,meter.AUDIO_METER_WIDTH,meter.AUDIO_METER_HEIGHT);
meter.canvasContext.stroke();
setTimeout(meter.drawLoop.bind(this),30);
}};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}amzn.c2c.SipmlAdapter=function(widget){this.contactContextToken=null;
this.webCallConfigurationSet=null;
this.videoEnabled=widget.videoCallClicked;
this.SIP_PROTOCOL="sip:";
this.AMAZON_SIP_DOMAIN="@amazon.com";
this.UDP_PROTOCOL="udp://";
this.WSS_URI_REGEXP=/^(?:ws{1,2}:\/\/)?([^:\/]*)(?::(\d+))?(?:\/.*)?$/;
this.audioStream=null;
this.videoStream=null;
this.widgetStrings=widget.strings;
this.widgetPointer=widget;
this.SIPML_URL="https://images-na.ssl-images-amazon.com/images/G/01/browser-scripts/sipml/sipml-1743198286._CB351660134_.js";
this.micOffImage="https://images-na.ssl-images-amazon.com/images/G/01/x-locale/cs/contact-us/images/mute-off.png";
this.micOnImage="https://images-na.ssl-images-amazon.com/images/G/01/x-locale/cs/contact-us/images/mute-on.png";
this.CANVAS_ID="audio_input_meter";
this.CANVAS_WIDTH=200;
this.CANVAS_HEIGHT=18;
this.audioInputMeter=new amzn.c2c.AudioInputMeter(this.CANVAS_ID,this.CANVAS_WIDTH,this.CANVAS_HEIGHT,widget.audioContext);
this.audioOn=true;
this.analyzeStatsIntervalId=null;
this.printStatsIntervalId=null;
};
amzn.c2c.SipmlAdapter.prototype.updateConnectivity=function(percent){if(percent>100){return;
}var adapter=this;
$("#connectivityMeter").show();
if(percent<=5){$("#connectivityStatus").html(adapter.widgetStrings.connectivityStatusGood);
}else{if(percent<20){$("#connectivityStatus").html(adapter.widgetStrings.connectivityStatusWeak);
}else{$("#connectivityStatus").html(adapter.widgetStrings.connectivityStatusBad);
}}};
amzn.c2c.SipmlAdapter.prototype.calculateConnectivity=function(packetsLost,packetsTotal){if(packetsLost&&packetsTotal&&packetsTotal>0){var connectivityPercent=(packetsLost/packetsTotal)*100;
this.updateConnectivity(connectivityPercent);
}};
amzn.c2c.SipmlAdapter.prototype.dumpStats=function(obj){var statsString="Timestamp:";
statsString+=obj.timestamp;
if(obj.names){names=obj.names();
for(var i=0;
i<names.length;
++i){statsString+="<br>";
statsString+=names[i];
statsString+=":";
statsString+=obj.stat(names[i]);
}}else{console.log("No names function");
if(obj.stat("audioOutputLevel")){statsString+="audioOutputLevel: ";
statsString+=obj.stat("audioOutputLevel");
statsString+="<br>";
}}return statsString;
};
amzn.c2c.SipmlAdapter.prototype.printAllStats=function(pc){var adapter=this;
this.printStatsIntervalId=setInterval(function(){if(pc&&pc.getStats){pc.getStats(function(stats){var statsString="";
var results=stats.result();
for(var i=0;
i<results.length;
++i){var res=results[i];
console.log(res);
statsString+="<h3>Report ";
statsString+=i;
statsString+="</h3>";
if(res.local){statsString+="<p>Local ";
statsString+=adapter.dumpStats(res.local);
}if(res.remote){statsString+="<p>Remote ";
statsString+=adapter.dumpStats(res.remote);
}}$("#allStats").get(0).innerHTML=statsString;
});
}},1000);
};
amzn.c2c.SipmlAdapter.prototype.getConnectivity=function(obj){if(obj.stat("packetsLost")&&obj.stat("packetsSent")){this.calculateConnectivity(obj.stat("packetsLost"),obj.stat("packetsSent"));
}};
amzn.c2c.SipmlAdapter.prototype.analyzeStats=function(pc){var adapter=this;
this.analyzeStatsIntervalId=setInterval(function(){if(pc&&pc.getStats){pc.getStats(function(stats){var results=stats.result();
for(var i=0;
i<results.length;
++i){var res=results[i];
if(res.local){adapter.getConnectivity(res.local);
}}});
}},1000);
};
amzn.c2c.SipmlAdapter.prototype.getPeerConnection=function(stack){if(stack&&stack.o_stack&&stack.o_stack.o_layer_dialog&&stack.o_stack.o_layer_dialog.ao_dialogs[0]&&stack.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr&&stack.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr.ao_sessions[0]&&stack.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr.ao_sessions[0].o_pc){return stack.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr.ao_sessions[0].o_pc;
}else{return null;
}};
amzn.c2c.SipmlAdapter.prototype.mediaStreamFail=function(){if(this.videoEnabled){$("#micWebcamError").show();
}else{$("#microphoneError").show();
}this.audioInputMeter.turnOffAudioMeter();
this.loadPlaceCallButton();
};
amzn.c2c.SipmlAdapter.prototype.toggleAudioHandler=function(){if(this.audioOn){$("#toggle_audio").get(0).innerHTML=this.widgetStrings.unmuteButton;
this.audioInputMeter.turnOffAudioMeter();
this.audioOn=false;
$("#micOnImage").hide();
$("#micOffImage").show();
}else{$("#toggle_audio").get(0).innerHTML=this.widgetStrings.muteButton;
$("#micOffImage").hide();
$("#micOnImage").show();
try{navigator.getUserMedia({audio:true},this.audioInputMeter.turnOnAudioMeter.bind(this.audioInputMeter),this.mediaStreamFail.bind(this));
}catch(e){console.log("getUserMedia threw exception :"+e);
}this.audioOn=true;
}if(!this.audioStream){return;
}var tracks=this.audioStream.getAudioTracks();
if(tracks){$.each(tracks,function(index,track){track.enabled=!track.enabled;
});
}};
amzn.c2c.SipmlAdapter.prototype.toggleVideoHandler=function(){if(!this.videoStream){return;
}var tracks=this.videoStream.getVideoTracks();
if(tracks){$.each(tracks,function(index,track){track.enabled=!track.enabled;
});
}};
amzn.c2c.SipmlAdapter.prototype.startWebcall=function(){try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;
navigator.getUserMedia({audio:true,video:this.videoEnabled},this.webcall.bind(this),this.mediaStreamFail.bind(this));
}catch(e){console.log("getUserMedia threw exception :"+e);
}};
amzn.c2c.SipmlAdapter.prototype.decodeHtml=function(html){var txt=document.createElement("textarea");
txt.innerHTML=html;
return txt.value;
};
amzn.c2c.SipmlAdapter.prototype.checkWebcallInfo=function(response){if(response&&typeof(response.contactContextToken)=="string"&&response.contactContextToken.length>0&&typeof(response.webCallConfigurationSet)!="undefined"&&typeof(response.webCallConfigurationSet.configurations)!="undefined"&&response.webCallConfigurationSet.configurations.length>0){return true;
}return false;
};
amzn.c2c.SipmlAdapter.prototype.handleWebcallInfo=function(responseObject){var adapter=this;
if(responseObject&&typeof(responseObject.webCallConfigurationSet)==="string"){responseObject.webCallConfigurationSet=adapter.decodeHtml(responseObject.webCallConfigurationSet);
responseObject.webCallConfigurationSet=JSON.parse(responseObject.webCallConfigurationSet);
}if(adapter.checkWebcallInfo(responseObject)){adapter.contactContextToken=responseObject.contactContextToken;
adapter.webCallConfigurationSet=responseObject.webCallConfigurationSet;
adapter.startWebcall();
}else{adapter.widgetPointer._error("Failed to call - non-user error: "+(responseObject?(responseObject.error):"no response received"));
}};
amzn.c2c.SipmlAdapter.prototype.getWebcallInfo=function(){var adapter=this;
var response=adapter.widgetPointer.options.initiateC2TCallback(this);
if(response&&typeof response.onloadend!="undefined"){var oldDone=response.onloadend;
response.onloadend=function(){var responseObject=JSON.parse(response.response);
if(typeof oldDone=="function"){oldDone();
}adapter.handleWebcallInfo(responseObject);
};
}else{if(response&&typeof response.done=="function"){response.done(function(responseObject){adapter.handleWebcallInfo(responseObject);
});
}else{adapter.handleWebcallInfo(response);
}}};
amzn.c2c.SipmlAdapter.prototype.loadInCallButtons=function(){$("#microphoneError").hide();
$("#micWebcamError").hide();
if($("#place_call").get(0)){$("#place_call").get(0).innerHTML=this.widgetStrings.connectingButton;
}$("#place_call").unbind("click");
$("#toggle_audio").show();
if(this.videoEnabled){$("#toggle_video").show();
}$("#micOnImage").show();
};
amzn.c2c.SipmlAdapter.prototype.webcall=function(stream){var adapter=this;
adapter.loadInCallButtons();
window.onbeforeunload=function(){return"Warning! Your Amazon call will be disconnected.";
};
adapter.audioInputMeter.turnOnAudioMeter(stream);
var hostMatch=adapter.WSS_URI_REGEXP.exec(adapter.webCallConfigurationSet.configurations[0].signalingEndpoint);
var host=hostMatch[1];
var proxy=adapter.UDP_PROTOCOL+host;
if(hostMatch[2]){proxy=proxy+":"+hostMatch[2];
}var toUri=adapter.SIP_PROTOCOL+"webcall_"+adapter.widgetPointer.options.serviceGeo+"_"+adapter.widgetPointer.options.serviceEnv+"@amazon.com";
adapter.options={ws_server:adapter.webCallConfigurationSet.configurations[0].signalingEndpoint,stun_server:adapter.webCallConfigurationSet.configurations[0].iceServers[0],from_uri:"sip:click2talkwidget@amazon.com",to_uri:toUri,realm:"10.112.0.92",outbound_proxy:proxy,context:adapter.contactContextToken,enable_video:adapter.videoEnabled};
adapter._addMessage("Placing call: "+adapter.contactContextToken);
adapter.placeCall(adapter.options);
return false;
};
amzn.c2c.SipmlAdapter.prototype.placeCall=function(options){var adapter=this;
var stack;
var session;
var onDisconnected=function(){if(session){session.hangup();
session=null;
}if(stack){stack.stop();
stack=null;
}adapter.audioStream=null;
adapter.videoStream=null;
adapter.loadPlaceCallButton();
if(adapter.printStatsIntervalId!==null){clearInterval(adapter.printStatsIntervalId);
}if(adapter.analyzeStatsIntervalId!==null){clearInterval(adapter.analyzeStatsIntervalId);
}adapter.audioInputMeter.turnOffAudioMeter();
adapter.widgetPointer.changeWebcallStatus(amzn.c2c.callStatusCodes.DISCONNECTED);
window.onbeforeunload=null;
window.onunload=null;
};
window.onunload=onDisconnected;
var startSession=function(){var call_type=options.enable_video?"call-audiovideo":"call-audio";
session=stack.newSession(call_type,{audio_remote:$("#remote_audio")[0],video_remote:$("#remote_video")[0],video_local:$("#local_video")[0],sip_caps:[{name:"+sip.ice"}],sip_headers:[{name:"X-AmznContext",value:options.context}]});
session.addEventListener("*",function(e){switch(e.type){case"connecting":adapter._addMessage("Connecting session.");
break;
case"connected":adapter.gotConnected=true;
$("#place_call").get(0).innerHTML=adapter.widgetStrings.connectedButton;
adapter.widgetPointer.changeWebcallStatus(amzn.c2c.callStatusCodes.CONNECTED);
adapter._addMessage("Session connected.");
break;
case"terminating":if($("#place_call").get(0)){$("#place_call").get(0).innerHTML=adapter.widgetStrings.hangingUpButton;
}adapter._addMessage("Terminating session.");
break;
case"terminated":adapter._addMessage("Session terminated.");
if(adapter.gotConnected){onDisconnected();
}else{adapter.audioInputMeter.turnOffAudioMeter();
adapter.startWebcall();
}break;
case"m_stream_audio_local_added":adapter.audioStream=e.session.o_session.get_stream_local();
break;
case"m_stream_audio_local_removed":adapter.audioStream=null;
break;
case"m_stream_video_local_added":adapter.videoStream=e.session.o_session.get_stream_local();
break;
case"m_stream_video_local_removed":adapter.videoStream=null;
break;
case"m_stream_audio_remote_added":var pc=adapter.getPeerConnection(stack);
if(pc!==null){adapter.analyzeStats(pc);
}break;
default:break;
}});
session.call(options.to_uri);
};
adapter.widgetPointer._find("a.c2c-hangup-button, a.c2c-back-button").unbind("click").click(function(event){onDisconnected();
event.preventDefault();
});
stack=new SIPml.Stack({realm:options.realm,impi:"Click2TalkWidget",impu:options.from_uri,ice_servers:[{url:options.stun_server}],password:"",websocket_proxy_url:options.ws_server,outbound_proxy_url:options.outbound_proxy,enable_rtcweb_breaker:false,enable_click2call:false,events_listener:{events:["started","stopped"],listener:function(e){adapter._addMessage("Stack "+e.type);
switch(e.type){case"started":startSession();
break;
case"stopped":break;
default:break;
}}}});
stack.start();
};
amzn.c2c.SipmlAdapter.prototype._addMessage=function(message,e){var additionalData="";
if(e!==undefined&&e.data!==undefined){additionalData=": "+JSON.stringify(e.data);
}console.log("[SIPML STATUS] "+new Date().toTimeString()+" "+message+" "+additionalData);
};
amzn.c2c.SipmlAdapter.prototype.loadPlaceCallButton=function(){var adapter=this;
if($("#place_call").get(0)){$("#place_call").get(0).innerHTML=adapter.widgetStrings.placeCallButton;
}$("#place_call").one("click",adapter.getWebcallInfo.bind(this));
$("#toggle_audio").hide();
$("#toggle_video").hide();
$("#connectivityMeter").hide();
};
amzn.c2c.SipmlAdapter.prototype.loadSipml=function(){var sipmlScript=document.createElement("script");
sipmlScript.type="text/javascript";
document.body.appendChild(sipmlScript);
sipmlScript.onload=this.loadPlaceCallButton.bind(this);
sipmlScript.src=this.SIPML_URL;
};
amzn.c2c.SipmlAdapter.prototype.bindButtons=function(){var adapter=this;
$("#toggle_audio").click(adapter.toggleAudioHandler.bind(this));
if(adapter.videoEnabled){$("#toggle_video").click(adapter.toggleVideoHandler.bind(this));
$("#remote_video").show();
$("#local_video").show();
}adapter.widgetPointer._find("a.c2c-back-button").unbind("click").click(function(event){adapter.widgetPointer._setState(adapter.widgetPointer.states.initial);
event.preventDefault();
});
};
amzn.c2c.SipmlAdapter.prototype.initSipmlWebcall=function(){var adapter=this;
adapter.loadSipml();
var webcallHtml='<div id="microphoneError" style="display:none">'+adapter.widgetStrings.micErrorMessage+"</div>"+'<div id="micWebcamError" style="display:none">'+adapter.widgetStrings.micWebcamErrorMessage+"</div>"+'<span id="place_call">'+adapter.widgetStrings.loadingButton+"</span>"+'<span id="toggle_audio" style="display:none">'+adapter.widgetStrings.muteButton+"</span>"+'<span id="toggle_video" style="display:none">'+adapter.widgetStrings.toggleVideoButton+"</span>"+'<div id="media">'+'<span id="micImage" style="min-width:15px;display:inline-block">'+'<img id="micOnImage" src='+adapter.micOnImage+' style="display:none;margin-top:2px">'+'<img id="micOffImage" src='+adapter.micOffImage+' style="display:none;margin-top:2px">'+"</span>"+'<canvas id="'+adapter.CANVAS_ID+'" width="'+adapter.CANVAS_WIDTH+'" height="'+adapter.CANVAS_HEIGHT+'" style="margin-left:2px;margin-top:2px"></canvas>'+'<div id="connectivityMeter" style="display:none;margin-top:2px"><b>'+adapter.widgetStrings.connectivityMeter+' <span id="connectivityStatus">'+adapter.widgetStrings.connectivityStatusUnknown+"</span></b></div>"+"<audio id=\"remote_audio\" autoplay volume='1.0'></audio>"+'<video id="local_video" style="display:none" width="320" height="240" autoplay mute></video>'+'<video id="remote_video" style="display:none" autoplay volume=\'1.0\'></video>'+"</div>"+'<div id="allStats"></div>';
adapter.widgetPointer._find("div.webcall-container").html(webcallHtml);
adapter.bindButtons();
};
})(jQuery);
(function($){if(typeof amzn=="undefined"){amzn={};
}if(typeof amzn.c2c=="undefined"){amzn.c2c={};
}var LOCAL_STORAGE_PHONE_NUMBERS_KEY="c2cSavedPhoneNumbers";
var EVENT_ERROR="Error";
var EVENT_CALL_STATUS_CHANGE="CallStatusChange";
var EVENT_STATE_CHANGE="StateChange";
amzn.c2c.nextClick2CallWidgetInstanceId=0;
amzn.c2c.click2callWidgetInstances=[];
amzn.c2c.callStatusCodes={INITIAL:"INITIAL",PENDING:"PENDING",DIALING:"DIALING",RINGING:"RINGING",CONNECTED:"CONNECTED",AGENT_JOINED:"AGENT_JOINED",BUSY:"BUSY",NO_ANSWER:"NO_ANSWER",ERROR:"ERROR",DISCONNECTED:"DISCONNECTED",UNKNOWN:"UNKNOWN"};
amzn.c2c.userErrors={UnknownNumberFault:"UnknownNumberFault",NumberBlockedFault:"NumberBlockedFault",MobileNumberNotAllowedFault:"MobileNumberNotAllowedFault",InvalidNumberLengthFault:"InvalidNumberLengthFault"};
amzn.c2c.key={ENTER:13,TAB:9,BACKSPACE:8,KEYUP:38,KEYDOWN:40,PAGEUP:33,PAGEDOWN:34};
amzn.c2c.defaultMasks={US:"(999) 999-9999"};
amzn.c2c.leadingZeroPrefixCountries={"IT":1,"VA":1,"CI":1,"GA":1,"GQ":1,"IO":1,"RW":1,"SB":1,"SM":1};
amzn.c2c.OTHER_COUNTRY_CODE="OTHER";
amzn.c2c.Click2CallWidget=function(container,options){this.instanceId=amzn.c2c.nextClick2CallWidgetInstanceId++;
amzn.c2c.click2callWidgetInstances.push(this);
this.options={click2TalkEnabled:false,c2cId:null,contextGUID:null,timezone:"America/Los_Angeles",locale:"enUS",allowExtension:true,showExtensionInstructionsOnFocus:true,autoTab:true,enterKeyStartsCall:true,allowBackspaceToPreviousField:true,preventNonNumerics:true,callMeButtonImgSrc:"",click2TalkButtonImgSrc:"",click2TalkVideoButtonImgSrc:"",placeCallButtonImgSrc:"",loadingButtonImgSrc:"",muteButtonImgSrc:"",unmuteButtonImgSrc:"",connectingButtonImgSrc:"",connectedButtonImgSrc:"",hangingUpButtonImgSrc:"",backButtonImgSrc:"",callMe5MinButtonImgSrc:"",hangUpButtonImgSrc:"",cancelCallButtonImgSrc:"",sortCountries:true,whenToCallOptions:[0,5],showWhenToCallOptionsAsButtons:false,defaultNumberFormat:[[3,3],[3,3],[4,4]],animationEnabled:true,animationDurationMs:500,animationEasingFunction:"linear",showTimeZone:true,showDialingCode:true,showDialingCodeExemptCountries:{US:1,CA:1,GU:1,VG:1,VI:1,PR:1},hideDialingCodeForSingleCountry:true,showOtherCountryOption:false,gotoCaseSubmittedForOtherCountry:false,showCountriesMissingName:false,debug:true,showErrors:true,serviceEnv:"test",serviceGeo:"na",protocol:"https",serviceHost:null,serviceSecureHost:null,usingTrustedCall:false,initiateTrustedCallCallback:function(){},initiateC2TCallback:function(){},preInitiateCallCallback:function(){},stateChangeCallback:function(){},callStatusChangeCallback:function(){},contextGUIDChangeCallback:function(){},postValidationCallback:function(){},errorCallback:function(){},savedPhoneNumbers:{},messageOfTheDayTemplate:'<div class="c2c-messageoftheday">%s</div>',additionalButtonMarkup:"",additionalFormMarkup:"",alwaysShowOutOfHours:false,alwaysShowInHours:false,alwaysShowAgentsAvail:false,alwaysShowAgentsUnavail:false,showDebugSection:false,crossDomain:true,staticJson:false,allowCountryMasking:false,customPhoneNumberField:null,onTheFlyValidation:false};
this.strings={initializing:"Loading...",availableHeader:"Request a call back",availableInstructions:"To talk with us, please enter your phone number.<br/>"+"(You'll need an open phone line to receive this call)",willReceptionistAnswer:"Will a receptionist answer this call?",extensionTip:"Enter your extension here. You can type a comma (,) to add a pause.",extensionInstructions:"Enter your extension here. You can type a comma (,) to add a pause.",otherCountryInstructions:"Please include the international dialing code for your country below.",yourNumberTip:"Enter your phone number here.",notAvailableHeader:"Call back service unavailable",notAvailableBody:"<p>At this time, our call back service is unavailable. "+"Please contact us at 1-866-216-1072</p>"+"<p>Thank you,<br/>Amazon.com Customer Service</p>",timedOutHeader:"We're sorry",timedOutBody:"<p>We are unable to connect with our call back service. "+"Please check your network connection or contact us at 1-866-216-1072</p>"+"<p>Thank you,<br/>Amazon.com Customer Service</p>",queueCapExceededHeader:"We're sorry",queueCapExceededBody:"<p>Because of high call volumes, we cannot take your call at this time.</p>",outOfHoursHeader:"Talk to us... just not right now!",outOfHoursBodyTop:"<p>Our customer service representatives are available:</p>",outOfHoursBodyBottom:"<p>During normal hours, please take advantage "+" of our convenient callback service.</p>",outOfHoursLoading:"",openAllDayHours:"Open all day",yes:"Yes",no:"No",labelCountry:"Country",labelYourNumber:"Your number",labelWhenToCall:"When to call",labelExtension:"Ext.",callMeButton:"Call Me",callMeButtonDisabled:"(Disabled)",callMe5MinButton:"Call Me in 5 Minutes",hangUpButton:"Hang up",cancelCallButton:"Cancel call",backButton:"Back",backButtonAlt:"Back",click2TalkButton:"Call Online",click2TalkButtonAlt:"Call Online",click2TalkButtonTip:"",availableC2THeader:"Call us online",availableC2TInstructions:"Talk to a customer service associate using "+"your computer's microphone and internet browser.",click2TalkVideoButton:"Call online with video",click2TalkVideoButtonAlt:"Call online with video",click2TalkVideoButtonTip:"",placeCallButton:"Place Call",placeCallButtonAlt:"Place Call",muteButton:"Mute",muteButtonAlt:"Mute",unmuteButton:"Unmute",unmuteButtonAlt:"Unmute",toggleVideoButton:"Toggle Video",toggleVideoButtonAlt:"Toggle Video",connectingButton:"Connecting...",connectingButtonAlt:"Connecting...",connectedButton:"Connected...",connectedButtonAlt:"Connected...",hangingUpButton:"Hanging Up...",hangingUpButtonAlt:"Hanging Up...",loadingButton:"Loading...",loadingButtonAlt:"Loading...",micErrorMessage:"No microphone found. Please connect a microphone and place call again.",micWebcamErrorMessage:"No microphone or webcam found. Please connect a "+"microphone and webcam and place call again.",connectivityStatusGood:"Good",connectivityStatusWeak:"Weak",connectivityStatusBad:"Bad",connectivityStatusUnknown:"Unknown",connectivityMeter:"Connectivity:",callMeButtonAlt:"Call Me",callMeButtonTip:"",callMeButtonDisabledAlt:"(Disabled)",callMeButtonDisabledTip:"Finish entering your number",hangUpButtonAlt:"Hang up",cancelCallButtonAlt:"Cancel call",estimateWait1Min:"Estimated wait: 1 minute",estimateWaitTime:"Estimated wait: %s minutes",whenToCallOptionNow:"Now",whenToCallOptionLater:"In %s minutes",startWebcallHeader:"Call Amazon Online",startWebcallMessage:"When ready, click Place Call to speak with Amazon Customer Service.<br/>"+"Make sure to have your computer's microphone and speakers turned on.",startWebcallStatus:"",virtualQueueHeader:"Waiting in line...",virtualQueueMessage:"When you phone rings, please answer it.<br/>"+"You will hear ringing until the other party answers. ",virtualQueueStatus:"You are currently in line for us to call you. Thanks for your patience!",connectingHeader:"Connecting...",connectingMessage:"When you phone rings, please answer it.<br/>"+"You will hear ringing until the other party answers. ",connectingStatus:"Connecting your call...",ringingHeader:"Connecting...",ringingMessage:"When you phone rings, please answer it.<br/>"+"You will hear ringing until the other party answers.",ringingStatus:"Ringing...",connectedHeader:"Call connected",connectedMessage:"",connectedStatus:"Your call is now connected.",connectedAndReattachedHeader:"Call in progress",connectedAndReattachedMessage:"",connectedAndReattachedStatus:"Your call is still connected.",pendingHeader:"Waiting to call you",pendingMessage:"",pendingStatus:"... in about %s minute",pendingStatusPlural:"... in about %s minutes",pendingStatusWaitUnknown:"... at the time you have set.",callEndedHeader:"Call ended",callEndedMessage:"<p>Your call with us has ended.</p>"+"<p>If you need to speak with us again, please <a %s>click here</a>"+" to place another call.</p>"+"<p>Thank you,<br/>Amazon.com Customer Service.</p>",userErrorNumberBlockedFaultHeader:"We're sorry",userErrorNumberBlockedFaultMessage:"<p>Your number has been blocked from receiving calls from our call back service.</p>"+"<p>Please contact 1-866-216-1072 for help with this.</p>",userErrorUnknownNumberFaultHeader:"We're sorry",userErrorUnknownNumberFaultMessage:"<p>Our call back service has no knowledge of the area code you have entered.</p>"+"<p>Please <a %s>try a different number</a> or contact 1-866-216-1072.</p>",userErrorMobileNumberNotAllowedFaultHeader:"We're sorry",userErrorMobileNumberNotAllowedFaultMessage:"<p>We cannot dial out to a cell phone number.</p>"+"<p>Please <a %s>click here</a> to place a call to a different phone number.</p>",userErrorInvalidNumberLengthFaultHeader:"We're sorry",userErrorInvalidNumberLengthFaultMessage:"<p>The number you have entered appears to be invalid.</p></p>"+"<p>Please <a %s>try a different number</a> or contact 1-866-216-1072.</p>",userInternalFailureFaultHeader:"We're sorry",userInternalFailureFaultMessage:"<p>An unexpected error occured.</p>",invalidCharsError:"Please only enter numbers (0-9) in the fields below.",invalidCharsExtensionError:"Please only enter numbers (0-9), #, * or a comma (,) in your extension below.",tooShortError:"Please enter at least %s digits in the field below.",tooLongError:"Please enter no more than %s digits in the field below.",callStatusUpdateError:"Oops! We are having trouble updating the status of your call.",caseSubmittedHeader:"Thank you",caseSubmittedMessage:"<p>A customer service representive will call you shortly.</p>",dialingCodePrefix:"+",areaCodeLeft:"(",areaCodeRight:")",numberDelimiter:"-",dayRangeDelimiter:"-",dayRangeTerminator:":",hourRangeDelimiter:" - ",hourRangeListDelimiter:", ",am:"AM",pm:"PM",midnight:"Midnight",noon:"Noon",everyDayOfTheWeek:"Every day of the week",dayNameMonday:"Monday",dayNameTuesday:"Tuesday",dayNameWednesday:"Wednesday",dayNameThursday:"Thursday",dayNameFriday:"Friday",dayNameSaturday:"Saturday",dayNameSunday:"Sunday","tzNameAmerica/Los_Angeles":"Pacific","tzNameEurope/London":"London","tzNameEurope/Paris":"Paris","tzNameEurope/Berlin":"Berlin","tzNameAsia/Tokyo":"Tokyo",countryNameOTHER:"Other...",countryNameAD:"Andorra",countryNameAE:"United Arab Emirates",countryNameAF:"Afghanistan",countryNameAL:"Albania",countryNameAM:"Armenia",countryNameAO:"Angola",countryNameAR:"Argentina",countryNameAT:"Austria",countryNameAU:"Australia",countryNameAW:"Aruba",countryNameAZ:"Azerbaijan",countryNameBA:"Bosnia and Herzegovina",countryNameBD:"Bangladesh",countryNameBE:"Belgium",countryNameBF:"Burkina Faso",countryNameBG:"Bulgaria",countryNameBH:"Bahrain",countryNameBJ:"Benin",countryNameBN:"Brunei",countryNameBO:"Bolivia",countryNameBR:"Brazil",countryNameBS:"The Bahamas",countryNameBW:"Botswana",countryNameBY:"Belarus",countryNameCA:"Canada",countryNameCD:"Democratic Republic of the Congo",countryNameCG:"Republic of the Congo",countryNameCH:"Switzerland",countryNameCI:"Ivory Coast",countryNameCL:"Chile",countryNameCM:"Cameroon",countryNameCN:"China",countryNameCO:"Colombia",countryNameCR:"Costa Rica",countryNameCU:"Cuba",countryNameCY:"Cyprus",countryNameCZ:"Czech Republic",countryNameDE:"Germany",countryNameDK:"Denmark",countryNameDO:"Dominican Republic",countryNameDZ:"Algeria",countryNameEC:"Ecuador",countryNameEE:"Estonia",countryNameEG:"Egypt",countryNameES:"Spain",countryNameET:"Ethiopia",countryNameFI:"Finland",countryNameFR:"France",countryNameGA:"Gabon",countryNameGB:"United Kingdom",countryNameGE:"Georgia",countryNameGG:"Guernsey",countryNameGH:"Ghana",countryNameGN:"Guinea",countryNameGQ:"Equatorial Guinea",countryNameGR:"Greece",countryNameGT:"Guatemala",countryNameGU:"Guam",countryNameHK:"Hong Kong",countryNameHN:"Honduras",countryNameHR:"Croatia",countryNameHT:"Haiti",countryNameHU:"Hungary",countryNameID:"Indonesia",countryNameIE:"Ireland",countryNameIL:"Israel",countryNameIM:"Isle of Man",countryNameIN:"India",countryNameIQ:"Iraq",countryNameIR:"Iran",countryNameIS:"Iceland",countryNameIT:"Italy",countryNameJE:"Jersey",countryNameJM:"Jamaica",countryNameJO:"Jordan",countryNameJP:"Japan",countryNameKE:"Kenya",countryNameKG:"Kyrgyzstan",countryNameKH:"Cambodia",countryNameKP:"North Korea",countryNameKR:"South Korea",countryNameKW:"Kuwait",countryNameKZ:"Kazakhstan",countryNameLA:"Laos",countryNameLB:"Lebanon",countryNameLI:"Liechtenstein",countryNameLK:"Sri Lanka",countryNameLT:"Lithuania",countryNameLU:"Luxembourg",countryNameLV:"Latvia",countryNameLY:"Libya",countryNameMA:"Morocco",countryNameMC:"Monaco",countryNameMD:"Moldova",countryNameME:"Montenegro",countryNameMG:"Madagascar",countryNameMK:"Macedonia",countryNameML:"Mali",countryNameMM:"Burma",countryNameMN:"Mongolia",countryNameMO:"Macau",countryNameMT:"Malta",countryNameMU:"Mauritius",countryNameMW:"Malawi",countryNameMX:"Mexico",countryNameMY:"Malaysia",countryNameMZ:"Mozambique",countryNameNA:"Namibia",countryNameNE:"Niger",countryNameNG:"Nigeria",countryNameNI:"Nicaragua",countryNameNL:"Netherlands",countryNameNO:"Norway",countryNameNP:"Nepal",countryNameNZ:"New Zealand",countryNameOM:"Oman",countryNamePA:"Panama",countryNamePE:"Peru",countryNamePG:"Papua New Guinea",countryNamePH:"Philippines",countryNamePK:"Pakistan",countryNamePL:"Poland",countryNamePR:"Puerto Rico",countryNamePS:"West Bank and Gaza",countryNamePT:"Portugal",countryNamePY:"Paraguay",countryNameQA:"Qatar",countryNameRO:"Romania",countryNameRS:"Serbia",countryNameRU:"Russia",countryNameSA:"Saudi Arabia",countryNameSD:"Sudan",countryNameSE:"Sweden",countryNameSG:"Singapore",countryNameSI:"Slovenia",countryNameSK:"Slovakia",countryNameSM:"San Marino",countryNameSN:"Senegal",countryNameSV:"El Salvador",countryNameSY:"Syria",countryNameTD:"Chad",countryNameTH:"Thailand",countryNameTJ:"Tajikistan",countryNameTM:"Turkmenistan",countryNameTN:"Tunisia",countryNameTR:"Turkey",countryNameTT:"Trinidad and Tobago",countryNameTW:"Taiwan",countryNameTZ:"Tanzania",countryNameUA:"Ukraine",countryNameUG:"Uganda",countryNameUS:"United States",countryNameUY:"Uruguay",countryNameUZ:"Uzbekistan",countryNameVA:"Vatican City",countryNameVE:"Venezuela",countryNameVG:"Virgin Islands, British",countryNameVI:"Virgin Islands, U.S.",countryNameVN:"Vietnam",countryNameYE:"Yemen",countryNameZA:"South Africa",countryNameZM:"Zambia",countryNameZW:"Zimbabwe"};
this.states={initial:{},available:{},outOfHours:{},callInProgress:{},callEnded:{},notAvailable:{},queueCapExceeded:{},timedOut:{},userError:{},caseSubmitted:{}};
for(var stateName in this.states){this.states[stateName].id=stateName;
}this.useVirtualQueue=false;
this.waitTimeEstimateMessage=null;
this.isWebcallEnabled=false;
this.isWebcallVideoEnabled=false;
this.videoCallClicked=false;
this.canWebcall=false;
this.startingWebcall=false;
this.audioContext=null;
this.userErrorCode=null;
this.container=container;
this.callStatusPollDelay=2000;
this.callStatusRetriesBeforeError=3;
this.callStatusRetriesBeforeGivingUp=6;
options.c2cId=TelephonyUtil.sanitizeGUID(options.c2cId);
options.contextGUID=TelephonyUtil.sanitizeGUID(options.contextGUID);
if(options){$.extend(this.options,options);
$.extend(this.strings,options.strings);
}if(options){$.extend(this.urls,options.urls);
}if(!(options.strings&&options.strings.callMeButton)){this.strings.callMeButton='<img src="'+this.options.callMeButtonImgSrc+'" alt="'+this.strings.callMeButtonAlt+'" title="'+this.strings.callMeButtonTip+'"/>';
}if(!(options.strings&&options.strings.callMeButtonDisabled)){this.strings.callMeButtonDisabled='<img src="'+this.options.callMeButtonDisabledImgSrc+'" alt="'+this.strings.callMeButtonAlt+'" title="'+this.strings.callMeButtonTip+'"/>';
}if(!(options.strings&&options.strings.cancelCallButton)){this.strings.cancelCallButton='<img src="'+this.options.cancelCallButtonImgSrc+'" alt="'+this.strings.cancelCallButtonAlt+'"/>';
}if(!(options.strings&&options.strings.hangUpButton)){this.strings.hangUpButton='<img src="'+this.options.hangUpButtonImgSrc+'" alt="'+this.strings.hangUpButtonAlt+'"/>';
}if(!(options.strings&&options.strings.backButton)){this.strings.backButton='<img src="'+this.options.backButtonImgSrc+'" alt="'+this.strings.backButtonAlt+'"/>';
}if(!(options.strings&&options.strings.click2TalkButton)){this.strings.click2TalkButton='<img src="'+this.options.click2TalkButtonImgSrc+'" alt="'+this.strings.click2TalkButtonAlt+'" title="'+this.strings.click2TalkButtonTip+'"/>';
}if(!(options.strings&&options.strings.placeCallButton)){this.strings.placeCallButton='<img src="'+this.options.placeCallButtonImgSrc+'" alt="'+this.strings.placeCallButtonAlt+'"/>';
}if(!(options.strings&&options.strings.connectingButton)){this.strings.connectingButton='<img src="'+this.options.connectingButtonImgSrc+'" alt="'+this.strings.connectingButtonAlt+'"/>';
}if(!(options.strings&&options.strings.connectedButton)){this.strings.connectedButton='<img src="'+this.options.connectedButtonImgSrc+'" alt="'+this.strings.connectedButtonAlt+'"/>';
}if(!(options.strings&&options.strings.hangingUpButton)){this.strings.hangingUpButton='<img src="'+this.options.hangingUpButtonImgSrc+'" alt="'+this.strings.hangingUpButtonAlt+'"/>';
}if(!(options.strings&&options.strings.loadingButton)){this.strings.loadingButton='<img src="'+this.options.loadingButtonImgSrc+'" alt="'+this.strings.loadingButtonAlt+'"/>';
}if(!(options.strings&&options.strings.click2TalkVideoButton)){this.strings.click2TalkVideoButton='<img src="'+this.options.click2TalkVideoButtonImgSrc+'" alt="'+this.strings.click2TalkVideoButtonAlt+'" title="'+this.strings.click2TalkVideoButtonTip+'"/>';
}this.log=amzn.cs.log.getLogger("click2call");
this.log.setPrefix("[c2c]");
if(this.options.showErrors){if(!this.options.debug){this.log.setLevel("WARN");
}}else{this.log.setLevel("OFF");
}var numbersInDb=TelephonyUtil.getFromLocalStorage(LOCAL_STORAGE_PHONE_NUMBERS_KEY);
if(numbersInDb){this.log.debug("Existing numbers:",numbersInDb);
this.options.savedPhoneNumbers=$.extend({},numbersInDb,this.options.savedPhoneNumbers);
}this.savedPhoneNumbers=this.options.savedPhoneNumbers;
this.hoursOfOperation=null;
this.c2cClient=new amzn.c2c.C2CServiceClient({serviceEnv:this.options.serviceEnv,serviceGeo:this.options.serviceGeo,protocol:this.options.protocol,serviceHost:this.options.serviceHost,logger:this.log});
this.states.initial.template="<p>"+this.strings.initializing+"</p>"+this.options.additionalButtonMarkup;
this.states.notAvailable.template="<h3>"+this.strings.notAvailableHeader+"</h3>"+this.strings.notAvailableBody+this.options.additionalButtonMarkup;
this.states.queueCapExceeded.template="<h3>"+this.strings.queueCapExceededHeader+"</h3>"+this.strings.queueCapExceededBody+this.options.additionalButtonMarkup;
this.states.timedOut.template="<h3>"+(this.strings.timedOutHeader||this.strings.notAvailableHeader)+"</h3>"+(this.strings.timedOutBody||this.strings.notAvailableBody)+this.options.additionalButtonMarkup;
this.states.outOfHours.template="<h3>"+this.strings.outOfHoursHeader+"</h3>"+this.strings.outOfHoursBodyTop+'<div class="c2c-hours">'+this.strings.outOfHoursLoading+"</div>"+this.strings.outOfHoursBodyBottom+this.options.additionalButtonMarkup;
var disabledCallButton=this.options.onTheFlyValidation?'<span class="c2c-callme-button-disabled">'+this.strings.callMeButtonDisabled+"</span>":"";
this.states.available.template="<h3>"+this.strings.availableHeader+"</h3>"+"<p>"+this.strings.availableInstructions+"</p>"+'<div class="c2c-form-row c2c-form-row-country">'+'<label for="c2c-country'+this.instanceId+'">'+this.strings.labelCountry+"</label>"+'<select class="c2c-country" id="c2c-country'+this.instanceId+'"></select>'+"</div>"+'<div class="c2c-number-validation-error" style="display: none"></div>'+'<div class="c2c-other-country-instructions" style="display: none">'+this.strings.otherCountryInstructions+"</div>"+'<div class="c2c-extension-instructions" style="display: none">'+this.strings.extensionInstructions+"</div>"+'<div class="c2c-form-row c2c-form-row-yournumber">'+'<label for="c2c-yournumber-'+this.instanceId+'">'+this.strings.labelYourNumber+"</label>"+'<span class="c2c-dialing-code"></span>'+'<span class="c2c-yournumber-container"></span>'+'<span class="c2c-extension-container">'+'<label class="c2c-extension-label" for="c2c-extension-'+this.instanceId+'">'+this.strings.labelExtension+"</label>"+'<input class="c2c-extension" id="c2c-extension-'+this.instanceId+'" '+'title="'+this.strings.extensionTip+'"></input>'+"</span>"+"</div>"+'<div class="c2c-form-row c2c-form-row-whentocall">'+'<label for="c2c-whentocall-'+this.instanceId+'">'+this.strings.labelWhenToCall+"</label>"+'<select class="c2c-whentocall" id="c2c-whentocall-'+this.instanceId+'"></select>'+"</div>"+'<div class="c2c-form-row c2c-form-row-receptionist" style="display: none">'+'<span class="c2c-receptionist-prompt">'+this.strings.willReceptionistAnswer+"</span>"+'<input type="radio" name="c2c-receptionist-radio" class="c2c-receptionist-radio" '+'checked value="0">'+"</input> "+this.strings.no+'<input type="radio" name="c2c-receptionist-radio" class="c2c-receptionist-radio" value="1">'+"</input> "+this.strings.yes+"</div>"+this.options.additionalFormMarkup+'<div class="c2c-callme-wait-time-estimate"></div>'+'<div class="c2c-form-row c2c-form-row-callme-button">'+'<span class="c2c-callme-button-spacer"></span>'+'<a href="#" class="c2c-callme-button">'+this.strings.callMeButton+"</a>"+disabledCallButton+'<span class="c2c-callme-whentocall-buttons"></span>'+this.options.additionalButtonMarkup+"</div>";
this.states.available.template+="</div>";
this.states.callInProgress.template='<h3 class="c2c-inprogress-header"></h3>'+'<span class="c2c-inprogress-message"></span>'+'<div class="c2c-inprogress-status">'+'<div class="c2c-inprogress-status-message"></div>'+'<div class="webcall-container" style="display:none"></div>'+"</div>"+'<div class="c2c-inprogress-update-error" style="display:none">'+this.strings.callStatusUpdateError+"</div>"+'<div class="c2c-inprogress-wait-time-estimate"></div>'+'<span class="c2c-hangup-button-spacer"></span>'+'<a href="#" class="c2c-hangup-button" style="display:none">'+this.strings.hangUpButton+"</a>"+'<a href="#" class="c2c-cancelcall-button" style="display:none">'+this.strings.cancelCallButton+"</a>"+'<a href="#" class="c2c-back-button" style="display:none">'+this.strings.backButton+"</a>"+this.options.additionalButtonMarkup;
this.states.callEnded.template='<h3 class="c2c-callended-header">'+this.strings.callEndedHeader+"</h3>"+'<span class="c2c-callended-message">'+this.strings.callEndedMessage.replace(/%s/,'href="#" class="c2c-call-again-link"')+"</span>"+this.options.additionalButtonMarkup;
this.states.userError.template='<h3 class="c2c-usererror-header"></h3>'+'<span class="c2c-usererror-message"></span>'+this.options.additionalButtonMarkup;
this.states.caseSubmitted.template='<h3 class="c2c-casesubmitted-header">'+this.strings.caseSubmittedHeader+"</h3>"+'<span class="c2c-casesubmitted-message">'+this.strings.caseSubmittedMessage+"</span>";
};
amzn.c2c.Click2CallWidget.prototype.initialize=function(){this._setState(this.states.initial);
};
amzn.c2c.Click2CallWidget.prototype.getString=function(key){return this.strings[key];
};
amzn.c2c.Click2CallWidget.prototype.setContextGUID=function(contextGUID){this.options.contextGUID=contextGUID;
if(typeof this.options.contextGUIDChangeCallback=="function"){this.options.contextGUIDChangeCallback(contextGUID);
}};
amzn.c2c.Click2CallWidget.prototype.getInstanceId=function(key){return this.instanceId;
};
amzn.c2c.Click2CallWidget.prototype._find=function(selector){return $(this.container).find(selector);
};
amzn.c2c.Click2CallWidget.prototype._raiseEvent=function(name,data){data.widget=this;
$(document).trigger("Click2Call/"+name,data);
};
amzn.c2c.Click2CallWidget.prototype._setCallStatus=function(callStatus){this.callStatus=callStatus;
if(typeof this.options.callStatusChangeCallback=="function"){this.options.callStatusChangeCallback(callStatus);
this._raiseEvent(EVENT_CALL_STATUS_CHANGE,{status:callStatus});
}this.log.debug("call status change: ",callStatus);
};
amzn.c2c.Click2CallWidget.prototype._error=function(debugMessage){if(this.options.showErrors){this.log.error(debugMessage);
}if(this.timedOut){this._setState(this.states.timedOut);
}else{this._setState(this.states.notAvailable);
}this.options.errorCallback(debugMessage);
this._raiseEvent(EVENT_ERROR,{message:debugMessage});
};
amzn.c2c.Click2CallWidget.prototype._requestCallStatus=function(onSuccess,onError){this.c2cClient.requestCallStatus({callContextId:this.options.contextGUID,onSuccess:onSuccess,onError:onError,maxRetries:0});
};
amzn.c2c.Click2CallWidget.prototype._requestClick2CallStatus=function(onSuccess,onError){this.c2cClient.requestClick2CallStatus({c2cId:this.options.c2cId,timezone:this.options.timezone,locale:this.options.locale,onSuccess:onSuccess,onError:onError});
};
amzn.c2c.Click2CallWidget.prototype._disconnectCall=function(onSuccess,onError){this.c2cClient.disconnectCall({contextId:this.options.contextGUID,onSuccess:onSuccess,onError:onError});
this._setState(this.states.callEnded);
};
amzn.c2c.Click2CallWidget.prototype._clearPhoneNumberErrors=function(){this._find(".c2c-number-validation-error").hide();
this._find(".c2c-invalid-field").removeClass("c2c-invalid-field");
};
amzn.c2c.Click2CallWidget.prototype._validatePhoneNumberFields=function(){var invalidCharsInExtension=false;
var invalidCharsErrors=[];
var tooShortErrors=[];
var tooLongErrors=[];
var format=this._getPhoneNumberFormat();
this._find("input.c2c-yournumber").each(function(){$(this).removeClass("c2c-invalid-field");
var errors=this.getFieldObject().validate();
for(var errorNum=0;
errorNum<errors.length;
errorNum++){var error=errors[errorNum];
if(error.constructor==amzn.c2c.InvalidCharsValidationError){invalidCharsErrors.push(error);
}else{if(error.constructor==amzn.c2c.TooShortValidationError){tooShortErrors.push(error);
}else{if(error.constructor==amzn.c2c.TooLongValidationError){tooLongErrors.push(error);
}}}}});
this._find("input.c2c-extension").each(function(){$(this).removeClass("c2c-invalid-field");
if(!$(this).val().match(/^[\d,#\*]*$/)){invalidCharsInExtension=true;
}});
var errorMessage=null;
var fieldsToHighlight=[];
if(invalidCharsErrors.length>0){errorMessage=invalidCharsErrors[0].getMessage();
for(var errorNum=0;
errorNum<invalidCharsErrors.length;
errorNum++){fieldsToHighlight.push(invalidCharsErrors[errorNum].getFieldInError().getDomElement());
}}else{if(tooShortErrors.length>0){errorMessage=tooShortErrors[0].getMessage();
fieldsToHighlight.push(tooShortErrors[0].getFieldInError().getDomElement());
}else{if(tooLongErrors.length>0){errorMessage=tooLongErrors[0].getMessage();
fieldsToHighlight.push(tooLongErrors[0].getFieldInError().getDomElement());
}else{if(invalidCharsInExtension){errorMessage=this.strings.invalidCharsExtensionError;
fieldsToHighlight=this._find("input.c2c-extension");
}}}}$.each(fieldsToHighlight,function(){$(this).addClass("c2c-invalid-field");
});
if(errorMessage){this._animateShow($(this.container).find(".c2c-number-validation-error").html(errorMessage));
}return !errorMessage;
};
amzn.c2c.Click2CallWidget.prototype._animateShow=function(jQuerySelector){$(jQuerySelector).amznSafeShow({animate:this.options.animationEnabled,durationMs:this.options.animationDurationMs,easingFunction:this.options.animationEasingFunction});
};
amzn.c2c.Click2CallWidget.prototype._animateHide=function(jQuerySelector){$(jQuerySelector).amznSafeHide({animate:this.options.animationEnabled,durationMs:this.options.animationDurationMs,easingFunction:this.options.animationEasingFunction});
};
amzn.c2c.Click2CallWidget.prototype.checkCallErrors=function(response){var widget=this;
if(response&&typeof response.contextId=="string"&&response.contextId.length>0){widget.setContextGUID(response.contextId);
}else{widget._setState(widget.states.notAvailable);
if(response&&typeof amzn.c2c.userErrors[response.error]!="undefined"){widget.userErrorCode=response.error;
widget._setState(widget.states.userError);
}else{widget._error("Failed to call - non-user error: "+(response?(response.error):"no response sent"));
}return true;
}};
amzn.c2c.Click2CallWidget.prototype._trustedCall=function(phoneNumber,countryCode,extension,viaReceptionist,whenToCallMinutes){var widget=this;
var response=this.options.initiateTrustedCallCallback(this,{phoneNumber:phoneNumber,country:countryCode,extensionDetails:{extension:extension,routeThroughReceptionist:viaReceptionist}},{callAfterMins:parseInt(whenToCallMinutes,10),virtualCall:!!widget.useVirtualQueue});
if(response&&typeof response.onloadend!="undefined"){var oldDone=response.onloadend;
response.onloadend=function(){var responseObject=JSON.parse(response.response);
widget.checkCallErrors(responseObject);
if(typeof oldDone=="function"){oldDone();
}return response;
};
}else{if(response&&typeof response.done=="function"){response.done(function(responseObject){widget.checkCallErrors(responseObject);
return response;
});
}else{widget.checkCallErrors(response);
return response;
}}};
amzn.c2c.Click2CallWidget.prototype._call=function(phoneNumber,countryCode,extension,viaReceptionist,whenToCallMinutes,phoneNumberFields){var response={};
var widget=this;
this.options.preInitiateCallCallback(this,{base:phoneNumberFields,countryCode:countryCode,ext:extension,receptionist:viaReceptionist});
this.c2cClient.initiateCall({c2cId:this.options.c2cId,contextId:this.options.contextGUID,whenToCallMinutes:whenToCallMinutes,phoneNumber:phoneNumber,countryCode:countryCode,extension:extension,viaReceptionist:viaReceptionist,virtualCall:!!this.useVirtualQueue,onSuccess:function(data,status){response=data;
},onError:function(xhr,status,error,code){widget.checkCallErrors({error:code});
response="";
}});
return response;
};
amzn.c2c.Click2CallWidget.prototype._initiateCall=function(whenToCallMinutes){if(!this._validatePhoneNumberFields()){return;
}this._savePhoneNumber();
if(typeof whenToCallMinutes==="undefined"){if(this.options.showWhenToCallOptionsAsButtons){whenToCallMinutes=0;
}else{whenToCallMinutes=this._find("select.c2c-whentocall").val();
}}this.callInitiatedTime=new Date().getTime();
var countryCode=this._getCurrentCountry();
this.estimatedCallBackTime=this.callInitiatedTime+whenToCallMinutes*60000;
var inputs=this._find("input");
var extension=inputs.filter(".c2c-extension").val();
var viaReceptionist=false;
if(extension){viaReceptionist=inputs.filter('.c2c-receptionist-radio[value="1"]').attr("checked");
}var phoneNumberFields=[];
inputs.filter(".c2c-yournumber").each(function(){var fieldValue=this.getFieldObject().getValue();
phoneNumberFields.push(fieldValue);
});
var phoneNumber=phoneNumberFields.join("");
if(typeof this.options.postValidationCallback==="function"){if(false===this.options.postValidationCallback(this,phoneNumber)){return;
}}var widget=this;
this.reattached=false;
this.callStatusPollingEnabled=false;
if(countryCode!==amzn.c2c.OTHER_COUNTRY_CODE){this._setCallStatus(whenToCallMinutes===0?amzn.c2c.callStatusCodes.DIALING:amzn.c2c.callStatusCodes.PENDING);
this._setState(this.states.callInProgress);
}var response={};
if(this.options.usingTrustedCall){response=widget._trustedCall(phoneNumber,countryCode,extension,viaReceptionist,whenToCallMinutes);
}else{response=widget._call(phoneNumber,countryCode,extension,viaReceptionist,whenToCallMinutes,phoneNumberFields);
}if(response&&typeof response.callStatusPollDelay!="undefined"){widget.callStatusPollDelay=response.callStatusPollDelay;
}widget.callStatusPollingEnabled=true;
this.log.debug("Call context ID: ",this.options.contextGUID);
if(countryCode===amzn.c2c.OTHER_COUNTRY_CODE&&this.options.gotoCaseSubmittedForOtherCountry){this._setState(this.states.caseSubmitted);
return;
}};
amzn.c2c.Click2CallWidget.prototype._tryPopulateWaitTimeEstimate=function(className){var waitTimeEstimateArea=this._find(className);
if(waitTimeEstimateArea===null){return false;
}if(this.waitTimeEstimateMessage===null){waitTimeEstimateArea.empty();
return false;
}this.log.debug(this.waitTimeEstimateMessage);
waitTimeEstimateArea.html(this.waitTimeEstimateMessage);
return true;
};
amzn.c2c.Click2CallWidget.prototype._populateWhenToCall=function(){var widget=this;
var whenToCallSelect=this._find(".c2c-whentocall");
var buttonArea=this._find(".c2c-callme-whentocall-buttons");
for(var optionNum=0;
optionNum<this.options.whenToCallOptions.length;
optionNum++){var waitLength=this.options.whenToCallOptions[optionNum];
var MS_PER_MINUTE=60000;
if(widget.timeToClosing!=null&&widget.timeToClosing<waitLength*MS_PER_MINUTE){continue;
}if(this.options.showWhenToCallOptionsAsButtons){if(waitLength===0){continue;
}var button=document.createElement("a");
button.href="#";
button.className="c2c-callme-later-button c2c-callme-in-"+waitLength+"min-button";
$(button).html(this.strings["callMe"+waitLength+"MinButton"]);
$(button).click(function(event){widget._initiateCall(waitLength);
event.preventDefault();
});
buttonArea.append(button);
}else{var optionText;
if(waitLength===0){optionText=this.strings.whenToCallOptionNow;
}else{optionText=this.strings.whenToCallOptionLater.replace(/%s/,waitLength);
}whenToCallSelect.append('<option value="'+waitLength+'">'+optionText+"</option>");
}}};
amzn.c2c.Click2CallWidget.prototype._populateCountries=function(){var countrySelect=this._find(".c2c-country");
this.fixedCountryCode=null;
if(this.countryCodesInOrder&&this.countryCodesInOrder.length==1){this.fixedCountryCode=this.countryCodesInOrder[1];
this._find(".c2c-form-row-country").hide();
}var countryList=[];
var countryCount=this.countryCodesInOrder.length;
for(var countryNum=0;
countryNum<countryCount;
countryNum++){var countryCode=this.countryCodesInOrder[countryNum];
var countryName=this.strings["countryName"+countryCode];
if(countryName){countryList.push({code:countryCode,name:countryName});
}else{if(this.options.showCountriesMissingName){countryList.push({code:countryCode,name:countryCode});
}}}var sortedCountries=countryList.slice(1);
if(this.options.sortCountries){sortedCountries.sort(function(a,b){if(a.code===amzn.c2c.OTHER_COUNTRY_CODE){return 1;
}if(b.code===amzn.c2c.OTHER_COUNTRY_CODE){return -1;
}if(a.name>b.name){return 1;
}if(a.name<b.name){return -1;
}return 0;
});
}countryList=[countryList[0]].concat(sortedCountries);
countryCount=countryList.length;
for(countryNum=0;
countryNum<countryCount;
countryNum++){var country=countryList[countryNum];
countrySelect.append('<option value="'+country.code+'">'+country.name+"</option>");
}};
amzn.c2c.Click2CallWidget.prototype._savePhoneNumberValues=function(countryCode,base,ext,receptionist){this.savedPhoneNumbers[countryCode]={base:base,ext:ext,receptionist:receptionist};
TelephonyUtil.putInLocalStorage(LOCAL_STORAGE_PHONE_NUMBERS_KEY,this.savedPhoneNumbers);
};
amzn.c2c.Click2CallWidget.prototype._savePhoneNumber=function(){var countryCode=this._getCurrentCountry();
var base=[];
this._find("input.c2c-yournumber").each(function(){base.push($(this).val());
});
var ext=this._find("input.c2c-extension").val();
var receptionist=this._find('input.c2c-receptionist-radio[value="1"]').attr("checked");
this._savePhoneNumberValues(countryCode,base,ext,receptionist);
};
amzn.c2c.Click2CallWidget.prototype._restorePhoneNumber=function(){var countryCode=this._getCurrentCountry();
var valuesByField=this.savedPhoneNumbers[countryCode];
if(!valuesByField){return;
}this._find("input.c2c-yournumber").each(function(fieldNum){var fieldVal=valuesByField.base[fieldNum];
if(fieldVal){$(this).val(fieldVal);
}});
this._find("input.c2c-extension").val(valuesByField.ext);
if(typeof valuesByField.ext=="string"&&valuesByField.ext.length>0){this._find("div.c2c-form-row-receptionist").show();
}else{this._find("div.c2c-form-row-receptionist").hide();
}if(valuesByField.receptionist){this._find('input.c2c-receptionist-radio[value="1"]').attr("checked",true);
}else{this._find('input.c2c-receptionist-radio[value="0"]').attr("checked",true);
}};
amzn.c2c.Click2CallWidget.prototype._getNumberField=function(format){var minDigits=format[0];
var maxDigits=format[1];
var inputElem=document.createElement("input");
inputElem.id="c2c-yournumber-"+this.instanceId;
inputElem.className="c2c-yournumber";
inputElem.type="text";
inputElem.maxLength=maxDigits;
inputElem.style.width=maxDigits+"em";
inputElem.title=this.strings.yourNumberTip;
return inputElem;
};
amzn.c2c.Click2CallWidget.prototype._getCurrentCountry=function(){if(this.fixedCountryCode){return this.fixedCountryCode;
}else{return this._find(".c2c-country").val();
}};
amzn.c2c.Click2CallWidget.prototype._getCurrentCountryConfig=function(){var countryCode=this._getCurrentCountry();
var countryConfig=this.callableCountries[countryCode];
return countryConfig;
};
amzn.c2c.Click2CallWidget.prototype._getPhoneNumberFormat=function(countryConfig){var config=countryConfig||this._getCurrentCountryConfig();
return config.fields||this.options.defaultNumberFormat;
};
var checkFormatNaStyle=function(format){if(format.length==3&&format[0].minLength==3&&format[0].maxLength==3&&format[1].minLength==3&&format[1].maxLength==3&&format[2].minLength==4&&format[2].maxLength==4){return true;
}else{return false;
}};
amzn.c2c.Click2CallWidget.prototype._updateNumberFormat=function(){var numberContainer=this._find(".c2c-yournumber-container");
numberContainer.empty();
var countryConfig=this._getCurrentCountryConfig();
var format=this._getPhoneNumberFormat(countryConfig);
if(this.options.showDialingCode&&!this.options.showDialingCodeExemptCountries[countryConfig.countryCode]&&!(this.countryCodesInOrder.length==1&&this.options.hideDialingCodeForSingleCountry)){this._find("span.c2c-dialing-code").show().html(this.strings.dialingCodePrefix+countryConfig.dialingCode);
}else{this._find("span.c2c-dialing-code").hide();
}var countryCode=this._getCurrentCountry();
if(this.options.allowCountryMasking&&checkFormatNaStyle(format)){numberContainer.append(new amzn.c2c.SinglePhoneNumberField({minLength:10,maxLength:10},this).getDomElement());
numberContainer.children(".c2c-yournumber").mask(amzn.c2c.defaultMasks.US,{placeholder:" "});
}else{if(format.length>1){numberContainer.append(this.strings.areaCodeLeft);
var firstField=new amzn.c2c.DividedPhoneNumberField(format[0],this).getDomElement();
numberContainer.append(firstField);
if(countryConfig.defaultAreaCode){$(firstField).val(countryConfig.defaultAreaCode);
}numberContainer.append(this.strings.areaCodeRight);
for(var formatIndex=1;
formatIndex<format.length;
formatIndex++){if(formatIndex!=1){numberContainer.append(this.strings.numberDelimiter);
}numberContainer.append(new amzn.c2c.DividedPhoneNumberField(format[formatIndex],this).getDomElement());
}}else{numberContainer.append(new amzn.c2c.SinglePhoneNumberField(format[0],this).getDomElement());
}}if(this.options.autoTab){numberContainer.children(".c2c-yournumber").keyup(function(event){if(this.value.length==this.maxLength&&event.which>32){$(this).next(".c2c-yournumber").focus().select().attr("justEntered","true");
}});
}var widget=this;
var keyDownEvent=function(event){if(event.which==amzn.c2c.key.ENTER&&widget.options.enterKeyStartsCall){widget._initiateCall();
}else{if(widget.options.allowBackspaceToPreviousField&&event.which===amzn.c2c.key.BACKSPACE&&this.value.length===0){var prevField=$(this).prev(".c2c-yournumber");
prevField.focus();
prevField.focus().val(prevField.val());
}}if(widget.options.autoTab){if($(this).attr("justEntered")=="true"){if(event.which==amzn.c2c.key.TAB){event.preventDefault();
}$(this).attr("justEntered","false");
}}if(widget.options.preventNonNumerics&&format.length>1){if(event.which==109||event.which==189||event.which==190||event.which==110||(event.which==57&&event.shiftKey)||(event.which==48&&event.shiftKey)){event.preventDefault();
}}};
var autoValidate=function(event){setTimeout(function(){if(!widget._validatePhoneNumberFields()){$(".c2c-callme-button").hide();
$(".c2c-callme-button-disabled").show();
}else{$(".c2c-callme-button").show();
$(".c2c-callme-button-disabled").hide();
}if(!event||!(event.which==amzn.c2c.key.ENTER&&widget.options.enterKeyStartsCall)){widget._clearPhoneNumberErrors();
}},5);
};
var numberChildren=numberContainer.children("input[type=text], input[type=tel]").keydown(keyDownEvent);
if(widget.options.onTheFlyValidation){numberChildren.change(autoValidate).keypress(autoValidate).keydown(autoValidate).focus(autoValidate).blur(autoValidate).click(autoValidate).bind("paste",autoValidate).bind("cut",autoValidate);
autoValidate();
}this._clearPhoneNumberErrors();
if(countryConfig.countryCode===amzn.c2c.OTHER_COUNTRY_CODE){widget._animateShow($(this.container).find("div.c2c-other-country-instructions"));
}else{widget._animateHide($(this.container).find("div.c2c-other-country-instructions"));
}this._find(".c2c-extension").val("");
};
amzn.c2c.Click2CallWidget.prototype._isCallInProgress=function(){switch(this.callStatus){case amzn.c2c.callStatusCodes.INITIAL:case amzn.c2c.callStatusCodes.PENDING:case amzn.c2c.callStatusCodes.DIALING:case amzn.c2c.callStatusCodes.RINGING:case amzn.c2c.callStatusCodes.CONNECTED:case amzn.c2c.callStatusCodes.AGENT_JOINED:return true;
default:return false;
}};
amzn.c2c.Click2CallWidget.prototype._isCallWaiting=function(){switch(this.callStatus){case amzn.c2c.callStatusCodes.INITIAL:case amzn.c2c.callStatusCodes.PENDING:case amzn.c2c.callStatusCodes.CONNECTED:return true;
default:return false;
}};
amzn.c2c.Click2CallWidget.prototype._isCallEnded=function(){return !this._isCallInProgress()&&this.callStatus!=amzn.c2c.callStatusCodes.INITIAL&&this.callStatus!=amzn.c2c.callStatusCodes.UNKNOWN;
};
amzn.c2c.Click2CallWidget.prototype._postRenderInitialState=function(){var widget=this;
if(navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)){widget.canWebcall=false;
}else{if(!!window.chrome&&widget.options.click2TalkEnabled){widget.canWebcall=true;
if(widget.audioContext===null){widget.audioContext=new AudioContext();
}}else{widget.canWebcall=false;
}}var onGetC2CStatusSuccess=function(data){if(data.messageOfTheDay){widget.messageOfTheDay=data.messageOfTheDay;
}if(data.c2cEnabled===false){widget._error("c2cEnabled is false");
return;
}if((!data.areAgentsAvailable&&data.isSkillInOpenHours&&!widget.options.alwaysShowAgentsAvail)||widget.options.alwaysShowAgentsUnavail){widget._error("areAgentsAvailable is not true (value is "+!(!data.areAgentsAvailable||widget.options.alwaysShowAgentsUnavail)+")");
return;
}var callableCountriesList=data.callableCountries;
widget.callableCountries={};
widget.countryCodesInOrder=[];
if(callableCountriesList){var countryCount=callableCountriesList.length;
for(var countryNum=0;
countryNum<countryCount;
countryNum++){var countryConfig=callableCountriesList[countryNum];
var countryCode=countryConfig.country;
if(typeof countryCode=="string"){countryCode=countryCode.toUpperCase();
}countryConfig.countryCode=countryCode;
widget.callableCountries[countryCode]=countryConfig;
widget.countryCodesInOrder.push(countryCode);
}}if(widget.options.showOtherCountryOption){widget.countryCodesInOrder.push(amzn.c2c.OTHER_COUNTRY_CODE);
widget.callableCountries[amzn.c2c.OTHER_COUNTRY_CODE]={countryCode:amzn.c2c.OTHER_COUNTRY_CODE,dialingCode:"",fields:[{minLength:2,maxLength:100}]};
}if(data.extensionsAllowed===false){widget.options.allowExtension=false;
}widget.hoursOfOperation=data.hoursOfOperation;
widget.timeToClosing=data.timeToClosing;
var isClosed=!data.isSkillInOpenHours;
isClosed=isClosed||widget.options.alwaysShowOutOfHours;
isClosed=isClosed&&!widget.options.alwaysShowInHours;
widget.useVirtualQueue=false;
var estimatedWaitTime=null;
if(data.queueTime!==null&&data.queueTime.available){widget.useVirtualQueue=!!data.isVirtualQueueEnabled;
estimatedWaitTime=data.queueTime.waitTime;
}if(data.isWebcallEnabled){widget.isWebcallEnabled=data.isWebcallEnabled;
}if(data.isWebcallVideoEnabled){widget.isWebcallVideoEnabled=data.isWebcallVideoEnabled;
}widget._updateWaitTimeEstimateMessage(estimatedWaitTime);
if(isClosed){widget._setState(widget.states.outOfHours);
}else{if(data.isQueueCapExceeded){widget._setState(widget.states.queueCapExceeded);
}else{widget._setState(widget.states.available);
}}};
var onGetC2CStatusFail=function(){widget._error("Could not get c2c status");
};
if(this.options.contextGUID){this._requestCallStatus(function(data){widget._setCallStatus(data.callStatusCode);
if(widget._isCallInProgress()){widget._updateWaitTimeEstimateMessage(widget._isCallWaiting()?data.estimatedWaitTime:null);
widget.reattached=true;
widget.callStatusPollingEnabled=true;
widget._setState(widget.states.callInProgress);
}else{widget._requestClick2CallStatus(onGetC2CStatusSuccess,onGetC2CStatusFail);
}},function(data){widget.setContextGUID(null);
widget.initialize();
});
}else{this._requestClick2CallStatus(onGetC2CStatusSuccess,onGetC2CStatusFail);
}};
amzn.c2c.Click2CallWidget.prototype._updateWaitTimeEstimateMessage=function(waitTime){this.waitTimeEstimateMessage=null;
if(waitTime===null){return;
}try{waitTime=parseInt(waitTime,10);
}catch(e){return;
}if(waitTime>=0){if(waitTime<=45000){this.waitTimeEstimateMessage=this.strings.estimateWait1Min;
}else{var minutes=Math.ceil((waitTime+15000)/60000);
this.waitTimeEstimateMessage=this.strings.estimateWaitTime.replace(/%s/,minutes);
}}return;
};
amzn.c2c.Click2CallWidget.prototype._postRenderOutOfHoursState=function(){var widget=this;
$(widget.container).find(".c2c-hours").amznHoursOfOperationUI({hours:widget.hoursOfOperation,strings:widget.strings,timezone:widget.options.timezone,showTimeZone:widget.options.showTimeZone});
};
amzn.c2c.Click2CallWidget.prototype._postRenderAvailableState=function(){var widget=this;
this._populateCountries();
this._find(".c2c-country").change(function(){widget._updateNumberFormat();
widget._restorePhoneNumber();
});
this._find(".c2c-country").keyup(function(evt){if(evt.which==amzn.c2c.key.KEYUP||evt.which==amzn.c2c.key.KEYDOWN||evt.which==amzn.c2c.key.PAGEUP||evt.which==amzn.c2c.key.PAGEDOWN){widget._updateNumberFormat();
widget._restorePhoneNumber();
}});
this._updateNumberFormat();
this._restorePhoneNumber();
var suppressWhenToCall=this._tryPopulateWaitTimeEstimate(".c2c-callme-wait-time-estimate")&&this.useVirtualQueue;
if(suppressWhenToCall||this.options.showWhenToCallOptionsAsButtons){this._find("div.c2c-form-row-whentocall").hide();
}if(!suppressWhenToCall){this._populateWhenToCall();
}if(!this.options.allowExtension){this._find(".c2c-extension-label").hide().end().find(".c2c-extension").hide();
}else{var extField=this._find("input.c2c-extension");
var receptionistPrompt=this._find("div.c2c-form-row-receptionist");
if(extField.val().length>0){receptionistPrompt.show();
}else{receptionistPrompt.hide();
}this._find("input.c2c-extension").keyup(function(){if($(this).val().length>0){widget._animateShow(receptionistPrompt);
}else{receptionistPrompt.hide(widget.options.receptionistPromptToggleSpeed);
}});
if(this.options.showExtensionInstructionsOnFocus){$(this.container).find("input.c2c-extension").focus(function(){widget._animateShow($(widget.container).find("div.c2c-extension-instructions"));
}).end().find(":not(input.c2c-extension)").focus(function(){widget._animateHide($(widget.container).find("div.c2c-extension-instructions"));
});
}}this._find("a.c2c-callme-button").click(function(event){event.preventDefault();
widget._initiateCall();
});
widget.startingWebcall=false;
if(this.isWebcallEnabled&&this.canWebcall){this._find("a.c2t-call-button").click(function(event){event.preventDefault();
widget.startingWebcall=true;
widget.videoCallClicked=false;
widget._setCallStatus(amzn.c2c.callStatusCodes.INITIAL);
widget._setState(widget.states.callInProgress);
});
if(this.isWebcallVideoEnabled){this._find("a.c2t-call-video-button").click(function(event){event.preventDefault();
widget.startingWebcall=true;
widget.videoCallClicked=true;
widget._setCallStatus(amzn.c2c.callStatusCodes.INITIAL);
widget._setState(widget.states.callInProgress);
});
}}};
amzn.c2c.Click2CallWidget.prototype._updateUserErrorStrings=function(){var headerString=this.strings["userError"+this.userErrorCode+"Header"];
var messageString=this.strings["userError"+this.userErrorCode+"Message"];
if(typeof headerString=="undefined"||typeof messageString=="undefined"){throw"Missing strings for "+this.userErrorCode;
}messageString=messageString.replace(/%s/,'href="#" class="c2c-call-again-link"');
this._find("h3.c2c-usererror-header").html(headerString).end().find("span.c2c-usererror-message").html(messageString).end();
};
amzn.c2c.Click2CallWidget.prototype._updateInProgressStrings=function(){var prefix;
var showHangUpButton=false;
this._tryPopulateWaitTimeEstimate(".c2c-inprogress-wait-time-estimate");
switch(this.callStatus){case amzn.c2c.callStatusCodes.INITIAL:case amzn.c2c.callStatusCodes.DIALING:case amzn.c2c.callStatusCodes.UNKNOWN:if(this.startingWebcall){prefix="startWebcall";
}else{prefix=this.useVirtualQueue?"virtualQueue":"connecting";
}break;
case amzn.c2c.callStatusCodes.RINGING:prefix="ringing";
break;
case amzn.c2c.callStatusCodes.CONNECTED:prefix=this.reattached?"connectedAndReattached":"connected";
showHangUpButton=true;
break;
case amzn.c2c.callStatusCodes.PENDING:prefix="pending";
break;
}if(showHangUpButton){this._find("a.c2c-hangup-button").show();
this._find("a.c2c-cancelcall-button").hide();
this._find("a.c2c-back-button").hide();
}else{this._find("a.c2c-hangup-button").hide();
if(this.startingWebcall){this._find("a.c2c-back-button").show();
this._find("a.c2c-cancelcall-button").hide();
}else{this._find("a.c2c-cancelcall-button").show();
this._find("a.c2c-back-button").hide();
}}var headerString=this.strings[prefix+"Header"];
var messageString=this.strings[prefix+"Message"];
var statusString=this.strings[prefix+"Status"];
if(this.callStatus==amzn.c2c.callStatusCodes.PENDING){if(this.callInitiatedTime){var now=new Date().getTime();
var minutesLeft=Math.max(1,Math.ceil((this.estimatedCallBackTime-now)/60000));
if(minutesLeft!=1){statusString=this.strings.pendingStatusPlural;
}this.log.debug("pending time: now:",now,"estimatedCallBackTime:",this.estimatedCallBackTime);
statusString=statusString.replace(/%s/,minutesLeft);
}else{statusString=this.strings.pendingStatusWaitUnknown;
}}this._find("h3.c2c-inprogress-header").html(headerString).end().find("span.c2c-inprogress-message").html(messageString).end().find("div.c2c-inprogress-status").find("div.c2c-inprogress-status-message").html(statusString);
};
amzn.c2c.Click2CallWidget.prototype._bindCallAgainLink=function(){var widget=this;
this._find("a.c2c-call-again-link").click(function(event){widget._setState(widget.states.initial);
event.preventDefault();
});
};
amzn.c2c.Click2CallWidget.prototype._postRenderUserErrorState=function(){try{this._updateUserErrorStrings();
}catch(err){this._error("Error updating userError state strings: "+err);
return;
}this._bindCallAgainLink();
};
amzn.c2c.Click2CallWidget.prototype._postRenderCallEndedState=function(){this._bindCallAgainLink();
};
amzn.c2c.Click2CallWidget.prototype.changeWebcallStatus=function(callStatus){var widget=this;
widget._setCallStatus(callStatus);
if(widget._isCallEnded()){widget._setState(widget.states.callEnded);
}else{widget._updateInProgressStrings();
}};
amzn.c2c.Click2CallWidget.prototype._pollCallStatus=function(pollingContext){var widget=this;
if(widget.state!=widget.states.callInProgress){return;
}if(widget.callStatusPollingEnabled){widget._requestCallStatus(function(data){widget.log.debug("Seq: ",pollingContext.sequenceId," Last: ",widget.lastCallStatusSequenceId);
if(pollingContext.sequenceId!=widget.lastCallStatusSequenceId){return;
}if(widget.state!=widget.states.callInProgress){return;
}$(widget.container).find(".c2c-inprogress-update-error").hide();
var oldCallStatus=widget.callStatus;
widget._setCallStatus(data.callStatusCode);
widget.log.debug("call status poll:",widget.callStatus);
if(widget._isCallEnded()){widget._setState(widget.states.callEnded);
}else{widget._updateWaitTimeEstimateMessage(widget._isCallWaiting()?data.estimatedWaitTime:null);
widget._updateInProgressStrings();
widget._scheduleNextCallStatusPoll();
}},function(){if(widget.state!=widget.states.callInProgress){return;
}if(pollingContext.retriesLeft>0){pollingContext.retriesLeft--;
var backoff=Math.pow(widget.callStatusPollDelay/1000,widget.callStatusRetriesBeforeGivingUp-pollingContext.retriesLeft-1)*1000;
widget.log.debug("did not get status, retries before giving up:",pollingContext.retriesLeft,"backoff ms:",backoff);
widget._scheduleNextCallStatusPoll(pollingContext,backoff);
}if(pollingContext.retriesLeft==widget.callStatusRetriesBeforeError){$(widget.container).find(".c2c-inprogress-update-error").show();
}return true;
});
}else{widget._scheduleNextCallStatusPoll();
}};
amzn.c2c.Click2CallWidget.prototype._scheduleNextCallStatusPoll=function(pollingContext,additionalDelay){if(typeof additionalDelay=="undefined"){additionalDelay=0;
}if(typeof this.lastCallStatusSequenceId=="undefined"){this.lastCallStatusSequenceId=0;
}if(typeof pollingContext=="undefined"){pollingContext={retriesLeft:this.callStatusRetriesBeforeGivingUp};
}pollingContext.sequenceId=++this.lastCallStatusSequenceId;
var timeoutTime=this.callStatusPollDelay;
if(additionalDelay>0){timeoutTime+=additionalDelay;
}var widget=this;
window.setTimeout(function(){widget._pollCallStatus(pollingContext);
},timeoutTime);
};
amzn.c2c.Click2CallWidget.prototype._postRenderCallInProgressState=function(){this._updateInProgressStrings();
var widget=this;
if(widget.startingWebcall){widget._find("a.c2c-back-button").unbind("click").click(function(event){widget.changeWebcallStatus(widget.states.callEnded);
event.preventDefault();
});
widget._find("div.webcall-container").show();
var sipmlAdapter=new amzn.c2c.SipmlAdapter(widget);
sipmlAdapter.initSipmlWebcall();
}else{widget._find("div.webcall-container").hide();
widget._find("a.c2c-hangup-button, a.c2c-cancelcall-button").unbind("click").click(function(event){widget._disconnectCall();
event.preventDefault();
});
widget._scheduleNextCallStatusPoll();
}};
amzn.c2c.Click2CallWidget.prototype._setStateClass=function(stateName){for(var state in this.states){if(state==stateName){$(this.container).addClass("c2c-state-"+state);
}else{$(this.container).removeClass("c2c-state-"+state);
}}};
amzn.c2c.Click2CallWidget.prototype._setState=function(newState){this.state=newState;
this.renderTemplate();
switch(newState){case this.states.initial:this._postRenderInitialState();
break;
case this.states.available:this._postRenderAvailableState();
break;
case this.states.outOfHours:this._postRenderOutOfHoursState();
break;
case this.states.callInProgress:this._postRenderCallInProgressState();
break;
case this.states.callEnded:this.setContextGUID(null);
this._postRenderCallEndedState();
break;
case this.states.userError:this.setContextGUID(null);
this._postRenderUserErrorState();
break;
case this.states.notAvailable:case this.states.queueCapExceeded:this.setContextGUID(null);
}if(typeof this.options.stateChangeCallback=="function"){this.options.stateChangeCallback(newState.id);
this._raiseEvent(EVENT_STATE_CHANGE,{state:newState.id});
}};
amzn.c2c.Click2CallWidget.prototype.renderTemplate=function(){var html=this.state.template;
var messageOfTheDay=this.options.messageOfTheDay||this.messageOfTheDay;
if(messageOfTheDay){html+=this.options.messageOfTheDayTemplate.replace(/%s/,messageOfTheDay);
}if(this.state===this.states.available&&this.isWebcallEnabled&&this.canWebcall){html+="<h4>"+this.strings.availableC2THeader+"</h4>"+"<p>"+this.strings.availableC2TInstructions+"</p>"+'<div class="c2t-form-row">'+'<span class="c2c-callme-button-spacer"></span>'+'<a href="#" class="c2t-call-button">'+this.strings.click2TalkButton+"</a>";
if(this.isWebcallVideoEnabled){html+="&nbsp;&nbsp"+'<a href="#" class="c2t-call-video-button">'+this.strings.click2TalkVideoButton+"</a>";
}html+="</div>";
}$(this.container).get(0).innerHTML=html;
this._setStateClass(this.state.id);
if(this.options.showDebugSection){this._renderDebugSection();
}};
amzn.c2c.Click2CallWidget.prototype._renderDebugSection=function(){var section=$("<div class='cs-c2c-debug-section'>").css({border:"1px #aaa solid",margin:"5px",padding:"5px"}).append($("<div>").text("c2cId: "+this.options.c2cId)).appendTo(this.container);
};
$.fn.amazonClick2Call=function(options){return this.each(function(){var widget=new amzn.c2c.Click2CallWidget(this,options);
$(this).addClass("c2c-container");
widget.initialize();
});
};
})(jQuery);
if("undefined"!==typeof(amznJQ)){amznJQ.declareAvailable("telephony-click2call");
}